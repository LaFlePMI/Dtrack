<!DOCTYPE html>
<html lang="en" data-theme="void">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CLARITY // 1.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap">

<style>
/* =========================================
   THEME ENGINE (UNCHANGED + DEFECT STYLES)
   ========================================= */
:root { --transition-speed: 0.3s; }

/* THEME: VOID (Deep Space - Default) */
[data-theme="void"] {
  --bg-main: #000000; --bg-panel: #050505; --bg-card: #0a0a0a;
  --border: #1e293b; --text-main: #e2e8f0; --text-muted: #64748b;
  --accent: #22d3ee; --accent-glow: rgba(34, 211, 238, 0.4);
  --status-offline-bg: #3d0a0a; --status-offline-border: #b91c1c;
  --status-process-bg: #0a2d4d; --status-process-border: #1e40af;
  --status-complete-bg: #0d3d1a; --status-complete-border: #15803d;
  --bg-gradient: radial-gradient(circle at 50% 0%, #111827 0%, #000000 80%);
}
/* THEME: CORE */
[data-theme="core"] {
  --bg-main: #0f172a; --bg-panel: #1e293b; --bg-card: #334155;
  --border: #475569; --text-main: #f1f5f9; --text-muted: #94a3b8;
  --accent: #60a5fa; --accent-glow: rgba(96, 165, 250, 0.4);
  --status-offline-bg: #4a1a1a; --status-offline-border: #dc2626;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1a3a1f; --status-complete-border: #15803d;
  --bg-gradient: linear-gradient(to bottom, #0f172a, #1e293b);
}
/* THEME: PAPER */
[data-theme="paper"] {
  --bg-main: #f8fafc; --bg-panel: #e8ecef; --bg-card: #ffffff;
  --border: #a0a8b4; --text-main: #0f172a; --text-muted: #475569; 
  --accent: #0284c7; --accent-glow: rgba(2, 132, 199, 0.2);
  --status-offline-bg: #7f1d1d; --status-offline-border: #991b1b;
  --status-process-bg: #1e3a8a; --status-process-border: #1e40af;
  --status-complete-bg: #166534; --status-complete-border: #15803d;
  --bg-gradient: none;
}
/* THEME: AMBER */
[data-theme="amber"] {
  --bg-main: #1c1917; --bg-panel: #292524; --bg-card: #3f3f46;
  --border: #525252; --text-main: #f5f5f4; --text-muted: #a1a1aa;
  --accent: #f59e0b; --accent-glow: rgba(245, 158, 11, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #b91c1c;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: linear-gradient(to bottom, #1c1917, #292524);
}
/* THEME: FOREST */
[data-theme="forest"] {
  --bg-main: #062a12; --bg-panel: #143d1f; --bg-card: #225c34;
  --border: #347447; --text-main: #ecfdf5; --text-muted: #6ee7b7;
  --accent: #4ade80; --accent-glow: rgba(74, 222, 128, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #991b1b;
  --status-process-bg: #0a2d4d; --status-process-border: #1e40af;
  --status-complete-bg: #0d3d1a; --status-complete-border: #15803d;
  --bg-gradient: linear-gradient(to bottom, #062a12, #143d1f);
}
/* THEME: PURPLE */
[data-theme="purple"] {
  --bg-main: #201438; --bg-panel: #35265f; --bg-card: #4c3d78;
  --border: #6d5b99; --text-main: #ede9fe; --text-muted: #a78bfa;
  --accent: #c084fc; --accent-glow: rgba(192, 132, 252, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #b91c1c;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: radial-gradient(circle at 70% 50%, #35265f 0%, #201438 80%);
}
/* THEME: CRIMSON */
[data-theme="crimson"] {
  --bg-main: #2d0a0f; --bg-panel: #3d1119; --bg-card: #4d1621;
  --border: #8b3a47; --text-main: #fce4ec; --text-muted: #f8bbd0;
  --accent: #ff6f7f; --accent-glow: rgba(255, 111, 127, 0.4);
  --status-offline-bg: #7f1d1d; --status-offline-border: #991b1b;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: radial-gradient(circle at 30% 50%, #3d1119 0%, #2d0a0f 80%);
}
/* THEME: SAFFRON */
[data-theme="saffron"] {
  --bg-main: #1e160a; --bg-panel: #2d2311; --bg-card: #3b301c;
  --border: #57462a; --text-main: #fff7ed; --text-muted: #fdba74;
  --accent: #f97316; --accent-glow: rgba(249, 115, 22, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #991b1b;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: linear-gradient(to bottom, #1e160a, #2d2311);
}
/* THEME: SOLAR */
[data-theme="solar"] {
  --bg-main: #1f1f1f; --bg-panel: #2c2c2c; --bg-card: #3b3b3b;
  --border: #525252; --text-main: #fafafa; --text-muted: #fcd34d;
  --accent: #facc15; --accent-glow: rgba(250, 204, 21, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #991b1b;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: linear-gradient(to bottom, #1f1f1f, #2c2c2c);
}
/* THEME: INDIGO */
[data-theme="indigo"] {
  --bg-main: #0c0717; --bg-panel: #1b1430; --bg-card: #2b224d;
  --border: #4e407a; --text-main: #eef2ff; --text-muted: #c7d2fe;
  --accent: #818cf8; --accent-glow: rgba(129, 140, 248, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #991b1b;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: radial-gradient(circle at 50% 50%, #1b1430 0%, #0c0717 80%);
}
/* THEME: FUCHSIA */
[data-theme="fuchsia"] {
  --bg-main: #1e0a17; --bg-panel: #36112c; --bg-card: #52183c;
  --border: #702e5b; --text-main: #fdf2f8; --text-muted: #fbcfe8;
  --accent: #ec4899; --accent-glow: rgba(236, 72, 153, 0.4);
  --status-offline-bg: #5a1a1a; --status-offline-border: #991b1b;
  --status-process-bg: #1a2d4a; --status-process-border: #1e40af;
  --status-complete-bg: #1f3a1a; --status-complete-border: #15803d;
  --bg-gradient: linear-gradient(to bottom, #1e0a17, #36112c);
}

/* =========================================
   BASE STYLES
   ========================================= */
body {
  margin: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background-color: var(--bg-main); color: var(--text-main);
  background-image: var(--bg-gradient); background-attachment: fixed;
  padding: 20px; min-height: 100vh; padding-top: 80px;
  transition: background-color var(--transition-speed), color var(--transition-speed);
}
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* HUD */
#hud-container {
  position: fixed; top: 0; left: 0; right: 0; background: var(--bg-panel);
  border-bottom: 1px solid var(--border); z-index: 1000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#hud-container.collapsed { transform: translateY(-100%); }
#hud-toggle {
  position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);
  background: var(--bg-panel); border: 1px solid var(--border); border-top: none;
  color: var(--accent); padding: 4px 15px; border-radius: 0 0 8px 8px; cursor: pointer;
  font-size: 0.8rem; font-weight: 700; letter-spacing: 1px;
}
.hud-content { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between; padding: 15px 20px; }
.hud-title { font-weight: 900; font-size: 1.5rem; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; text-shadow: 0 0 15px var(--accent-glow); }
.control-group { display: flex; align-items: center; gap: 10px; }
.divider { width: 1px; height: 25px; background: var(--border); margin: 0 5px; }

/* INPUTS & BUTTONS */
.nexus-input { background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 4px; font-size: 0.85rem; width: 200px; outline: none; transition: all 0.2s; }
.nexus-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
.btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; transition: all 0.2s; }
.btn:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
.btn-primary { background: var(--accent); color: var(--bg-main); border-color: var(--accent); font-weight: 800; }
.btn-danger { border-color: #ef4444; color: #ef4444; } 
.btn-active { background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }

.quick-add input {
    background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); 
    padding: 6px 10px; border-radius: 3px; font-size: 0.8rem; width: 100%; outline: none; transition: all 0.2s;
}
.quick-add input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-glow); }

/* BOARD */
#board-canvas { 
    display: grid; grid-template-columns: repeat(5, 1fr); gap: 25px; padding-bottom: 100px; 
    align-items: flex-start; overflow-x: auto; min-width: 100%;
}
@media (max-width: 1200px) { #board-canvas { grid-template-columns: repeat(5, minmax(300px, 1fr)); } }

.column, .grid-blank-cell {
    border: 1px solid var(--border); border-radius: 8px; max-height: 85vh; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); min-height: 100px; position: relative;
}
.column { background: var(--bg-panel); display: flex; flex-direction: column; }

/* Column editor state (yellow while editing) */
.column.editing { background: linear-gradient(180deg, rgba(255,246,214,0.6), var(--bg-panel)); border-color: #e8d99b; }
.column-editor { padding: 8px; }
.column-editor.hidden { display: none; }
.column-editor:not(.hidden) { display: block; }
.grid-blank-cell {
    background: var(--bg-main); border: 1px dashed var(--border); opacity: 0.4; 
    cursor: grab; display: flex; align-items: center; justify-content: center;
}
.grid-blank-cell:hover { opacity: 0.7; }

/* HEADERS & REMOVAL */
.column-header { 
    padding: 15px; border-bottom: 1px solid var(--border); font-weight: 800; font-size: 1rem; 
    cursor: grab; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; position: relative; 
}
.column-title-text { cursor: text; border-bottom: 1px dashed transparent; }
.column-title-text:hover { color: var(--accent); border-bottom-color: var(--accent); }
.remove-column-btn { opacity: 0; cursor: pointer; color: var(--text-muted); padding: 5px; border-radius: 4px; transition: opacity 0.2s; }
.column-header:hover .remove-column-btn { opacity: 1; }
.column-header:hover .remove-column-btn:hover { color: var(--accent); }
.grid-blank-cell .remove-blank-btn {
    position: absolute; bottom: 5px; right: 5px; padding: 2px 5px; font-size: 0.6rem; 
    line-height: 1; border: 1px solid var(--border); border-radius: 4px; background: transparent; 
    color: var(--text-muted); opacity: 0; transition: all 0.2s; cursor: pointer;
}
.grid-blank-cell:hover .remove-blank-btn { opacity: 1; }
.grid-blank-cell:hover .remove-blank-btn:hover { border-color: var(--accent); color: var(--accent); }

.column-content { flex-grow: 1; overflow-y: auto; padding: 12px; min-height: 150px; scroll-behavior: smooth; }
.badge { background: var(--border); color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px; }

/* CARDS */
.task-card { 
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 12px; 
    margin-bottom: 12px; cursor: grab; border-left-width: 4px; 
    transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s, background 0.3s; position: relative;
}
.task-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

.task-notes-preview {
    font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; margin-bottom: 10px;
    max-height: 4.5em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
    /* Standard (non-prefixed) line-clamp for browsers that support the modern property */
    line-clamp: 3;
    -webkit-line-clamp: 3; -webkit-box-orient: vertical;
}

/* CLARITY: New Features Styling */
.tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
.tag-pill { 
    font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; background: rgba(255,255,255,0.1); 
    color: var(--text-muted); border: 1px solid var(--border);
}
.progress-bar-container {
    width: 100%; height: 4px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden;
}
.progress-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; }

/* STATUS ANIMATIONS */
@keyframes pulseGlow {
  0% { box-shadow: 0 0 5px rgba(0,0,0,0); }
  50% { box-shadow: 0 0 15px var(--pulse-color), inset 0 0 10px var(--pulse-color-inset); }
  100% { box-shadow: 0 0 5px rgba(0,0,0,0); }
}
@keyframes jitter {
  0%, 100% { transform: translate(0, 0); }
  25% { transform: translate(-0.5px, 0.5px); }
  50% { transform: translate(0.5px, -0.5px); }
  75% { transform: translate(-0.5px, -0.5px); }
}
@keyframes subtleSparkle {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.05); } 
}
@keyframes exclamationPulse {
  0% { transform: scale(0.8) translateX(-8px); opacity: 0.8; }
  25% { transform: scale(1.3) translateX(0px); opacity: 1; }
  50% { transform: scale(1.4) translateX(8px); opacity: 1; }
  75% { transform: scale(1.3) translateX(0px); opacity: 1; }
  100% { transform: scale(0.8) translateX(-8px); opacity: 0.8; }
}
.exclamation-icon {
  display: inline-block; font-weight: 900; font-size: 2rem; 
  color: #ef4444; animation: exclamationPulse 2s infinite ease-in-out;
  text-shadow: 0 0 12px rgba(239, 68, 68, 0.8);
}

.status-offline {
    background: var(--status-offline-bg); border-color: var(--status-offline-border); 
    --pulse-color: rgba(180, 28, 28, 0.8); --pulse-color-inset: rgba(180, 28, 28, 0.3);
    animation: jitter 0.5s infinite alternate, pulseGlow 2s infinite ease-in-out;
    box-shadow: inset 0 0 20px rgba(180, 28, 28, 0.6), 0 0 15px rgba(180, 28, 28, 0.5);
    position: relative;
  color: #ffffff;
}
.status-offline::before {
    content: '!';
    position: absolute;
    top: 6px;
    right: 10px;
    font-weight: 900;
    font-size: 1.8rem;
    color: #fca5a5;
    animation: exclamationPulse 2s infinite ease-in-out;
    text-shadow: 0 0 8px rgba(180, 28, 28, 0.8);
}
.status-inprocess {
    background: #1a3f5a; border-color: #0ea5e9;
    --pulse-color: rgba(6, 182, 212, 0.8); --pulse-color-inset: rgba(6, 182, 212, 0.25);
    animation: pulseGlow 2.5s infinite ease-in-out;
    box-shadow: inset 0 0 20px rgba(6, 182, 212, 0.4), 0 0 15px rgba(6, 182, 212, 0.3);
  color: #ffffff;
}
.status-complete { 
    background: #1a3f2a; border-color: #10b981;
    --pulse-color: rgba(52, 211, 153, 0.7); --pulse-color-inset: rgba(52, 211, 153, 0.2);
    animation: pulseGlow 4s infinite ease-in-out, subtleSparkle 4s infinite ease-in-out; 
    box-shadow: inset 0 0 20px rgba(52, 211, 153, 0.35), 0 0 15px rgba(52, 211, 153, 0.25);
    opacity: 1;
  color: #ffffff;
}
.status-none {
    border-left-color: var(--border); opacity: 0.5; animation: none; box-shadow: none;
    transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s;
}
.status-none:hover { opacity: 1; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

.task-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 8px; line-height: 1.4; cursor: text; }
.task-meta { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; }
.edit-area { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border); }
.task-card.expanded .edit-area { display: block; }
.date-divider { text-align: center; font-size: 0.7rem; color: var(--accent); margin: 10px 0; font-weight: 800; letter-spacing: 2px; opacity: 0.8; }
.hidden { display: none !important; }

/* MODALS */
#toast { 
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--border);
    border-left-width: 5px; padding: 10px 20px; border-radius: 4px;
    font-size: 0.8rem; font-weight: 700; z-index: 2000;
    opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
}
#toast.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }

.modal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.9); z-index: 3000;
    display: none; align-items: center; justify-content: center;
}
.modal.visible { display: flex; }
.modal-content {
    background: var(--bg-panel); border: 1px solid var(--border);
    padding: 20px; border-radius: 8px; width: 80%; max-width: 600px;
    max-height: 90vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0, 0, 0, 0.4); 
}

/* Reports modal fullscreen variant */
.modal-content.reports-fullscreen {
  width: 95vw !important;
  height: 90vh !important;
  max-width: none !important;
  max-height: none !important;
  padding: 12px 16px !important;
}

.report-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.reports-canvas-full { width:100% !important; height: calc(100% - 160px) !important; }
.modal h2 { margin-top: 0; color: var(--accent); } 
.trash-card, .archive-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin-bottom: 8px; 
    display: flex; justify-content: space-between; align-items: center;
}
.trash-card { border-left: 4px solid #ef4444; } 
.archive-card { border-left: 4px solid var(--accent); } 
.trash-card .trash-meta, .archive-card .archive-meta { font-size: 0.8rem; color: var(--text-muted); }
.trash-card .btn, .archive-card .btn { margin-left: 10px; }

.archive-group-header {
    cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    color: var(--accent); border-bottom: 1px dashed var(--border); padding: 10px 5px; 
    margin-top: 15px; font-weight: 700; font-size: 1.1rem; user-select: none; transition: opacity 0.2s;
}
.archive-group-header:hover { opacity: 0.8; }
.archive-group-content { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; }
.archive-group-content.collapsed { max-height: 0; opacity: 0; }

/* NEW: DEFECT TRACKER STYLES */
#defect-tracker-view {
    padding-bottom: 100px; overflow-x: hidden; min-width: 100%; display: none;
}

.defect-table {
    width: 100%; border-collapse: separate; border-spacing: 0 10px;
}
.defect-row {
    background: var(--bg-card); border: 1px solid var(--border);
    transition: all 0.2s;
}
.defect-row:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
.defect-id { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--accent); }
.severity-high { background: rgba(59, 130, 246, 0.15); border-left: 4px solid #3b82f6; }
.severity-medium { background: rgba(59, 130, 246, 0.12); border-left: 4px solid #60a5fa; }
.severity-low { background: rgba(34, 211, 238, 0.08); border-left: 4px solid var(--accent); }
.status-badge {
    padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
}
.status-open { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid #3b82f6; }
.status-progress { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid #60a5fa; }
.status-fixed { background: rgba(34, 211, 238, 0.2); color: var(--accent); border: 1px solid var(--accent); }
.status-closed { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid #10b981; }

.type-pill {
    background: var(--border); color: var(--text-main); padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; 
}

#reports-section {
    margin-top: 40px; padding: 20px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.chart-container { position: relative; height: 300px; margin-bottom: 30px; }

/* Modal reuse */
#defect-modal .modal-content { max-width: 600px; }
#import-defects-file { display: none; }

/* Red Tag Tracker Specific Styles */
.red-tag-table-container { max-height: 70vh; overflow-y: auto; }
.red-tag-table-container::-webkit-scrollbar { height: 8px; width: 8px; }
.red-tag-table-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
.red-tag-truncate-cell { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.red-tag-status-repaired { background-color: #d1fae5; color: #065f46; }
.red-tag-status-scrap { background-color: #fee2e2; color: #991b1b; }
.red-tag-status-process { background-color: #e0f2fe; color: #0369a1; }
/* Highlight rows with missing critical data (NC# or Status missing) */
.red-tag-data-warning { background-color: #fee2e2 !important; border-left: 4px solid #f87171; }

.red-tag-table {
    width: 100%; border-collapse: separate; border-spacing: 0 10px;
}
.red-tag-row {
    background: var(--bg-card); border: 1px solid var(--border);
    transition: all 0.2s;
}
.red-tag-row:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.6); }

.red-tag-description-cell {
  white-space: pre-wrap; word-wrap: break-word; max-width: 300px;
}

/* Floating quick-actions for Red Tag (New NC / Reports) */
.floating-rt {
    position: fixed;
    right: 18px;
    bottom: 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1600;
}
.floating-rt.hidden { display: none; }
.floating-btn {
    width: 56px;
    height: 56px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    padding: 0;
    cursor: pointer;
}
.floating-btn.btn { background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--border); }
.floating-btn.btn-primary { background: var(--accent); color: var(--bg-main); border-color: var(--accent); }
@media (max-width: 600px) {
  .floating-rt { right: 12px; bottom: 12px; }
  .floating-btn { width: 48px; height: 48px; font-size: 16px; }
}

</style>
</head>
<body>
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div style="background:#111; padding:40px; border:1px solid #333; text-align:center; border-radius:8px;">
        <h1 style="color:#22d3ee; margin-bottom:20px;">CLARITY // ACCESS</h1>
        <input type="email" id="login-email" placeholder="Email" style="display:block; margin:10px auto; padding:10px; width:250px; color:#888; background:#222; border:1px solid #444;">
        <input type="password" id="login-pass" placeholder="Password" style="display:block; margin:10px auto; padding:10px; width:250px; color:#888; background:#222; border:1px solid #444;">
        <button id="login-btn" disabled onclick="if(window.app) { window.app.login() } else { alert('App still loading...') }" class="btn btn-primary" style="width:100%; padding:12px;">AUTHORIZE</button>
        <p id="login-error" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="hud-container">
  <div class="hud-content">
    <div class="control-group">
      <div class="hud-title">CLARITY</div>
      <div class="divider"></div>
      
      <input id="search-input" class="nexus-input" placeholder="Filter tasks..." oninput="app.handleSearch(this.value)">
      
      <select class="nexus-input" style="width:150px;" onchange="window.app?.setTheme(this.value)">
        <option value="void">Theme: Void</option>
        <option value="core">Theme: Core</option>
        <option value="paper">Theme: Paper</option>
        <option value="amber">Theme: Amber</option>
        <option value="forest">Theme: Forest</option>
        <option value="purple">Theme: Purple</option>
        <option value="crimson">Theme: Crimson</option>
        <option value="saffron">Theme: Saffron</option>
        <option value="solar">Theme: Solar</option>
        <option value="indigo">Theme: Indigo</option>
        <option value="fuchsia">Theme: Fuchsia</option>
      </select>
    </div>

    <div class="control-group">
      <button id="hud-settings-btn" class="btn" onclick="app.openHudSettingsModal()">‚öôÔ∏è Settings</button>
    </div>
    <div id="hud-toggle" onclick="window.app?.toggleHud()" style="cursor:pointer; margin-top:8px; text-align:center; color:var(--text-muted); font-size:0.85rem;">HIDE CONTROLS</div>
  </div>
</div>
</div>

<div id="board-canvas"></div>
<div id="defect-tracker-view">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h1 style="font-size:2rem; font-weight:900; color:var(--accent); text-shadow:0 0 20px var(--accent-glow);">RED TAG TRACKER</h1>
  </div>
  <!-- Top quick-actions: New NC + Generate Report (sticky at top of defect view) -->
  <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:12px;">
    <button class="btn btn-primary" onclick="app.defectTracker.prepareAddNC()">+ NEW NC</button>
    <button class="btn" onclick="(function(){app.defectTracker.openReportsModal(); setTimeout(()=>{ try{ app.defectTracker._renderReportFromControls(); }catch(e){} },150); })()">Generate Report</button>
  </div>
  <div style="display:flex; gap:10px; margin-bottom:20px;">
    <div style="flex:1;">
      <label style="font-size:0.8rem; color:var(--text-muted);">Search (NC#, Serial, Part...)</label>
      <input id="red-tag-search" class="nexus-input" placeholder="Search..." oninput="app.defectTracker.handleSearch(this.value)">
    </div>
    <div style="width:200px;">
      <label style="font-size:0.8rem; color:var(--text-muted);">Status Filter</label>
      <select id="red-tag-status-filter" class="nexus-input" onchange="app.defectTracker.handleFilterChange()">
        <option value="ALL">All Statuses</option>
        <option value="REPAIRED/CLOSED">REPAIRED/CLOSED</option>
        <option value="SCRAP">SCRAP</option>
        <option value="IN PROCESS">IN PROCESS</option>
      </select>
    </div>
  </div>
  <div class="red-tag-table-container shadow-md rounded-lg border border-[var(--border)]" id="red-tag-table-container">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--bg-panel); border-bottom:1px solid var(--border);">
      <span style="color:var(--accent); font-weight:700;">NC Record List</span>
      <div style="display:flex; gap:8px; align-items:center;">
      </div>
    </div>
    <table id="red-tag-table" class="min-w-full divide-y divide-[var(--border)] border-collapse">
      <thead style="background: var(--bg-panel); position: sticky; top:0; z-index:10;">
        <tr>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">NC#</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Status</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Part Number</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Serial</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Part Name</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Family</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Date Logged</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Qty</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Inspector</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Description</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Disposition</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Notes</th>
          <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem;">Actions</th>
        </tr>
      </thead>
      <tbody id="red-tag-table-body" style="background: var(--bg-main);"></tbody>
    </table>
    <div id="red-tag-no-results" class="hidden text-center py-10 text-[var(--text-muted)] text-lg bg-[var(--bg-main)] rounded-b-xl">
      No red tag issues found matching the current filters.
    </div>
  </div>
  <footer style="margin-top:20px; text-align:center; color:var(--text-muted); font-size:0.9rem;">
    <span id="red-tag-record-count">Loading records...</span>
  </footer>
</div>
<div id="toast"></div>

  <!-- HUD SETTINGS MODAL -->
  <div id="hud-settings-modal" class="modal">
    <div class="modal-content" style="max-width:720px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h2 style="color:var(--accent); margin:0;">Settings</h2>
        <button class="btn" onclick="document.getElementById('hud-settings-modal').classList.remove('visible')">Close</button>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div style="background:var(--bg-panel); padding:12px; border:1px solid var(--border); border-radius:6px;">
          <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:0.95rem;">Board Controls</h3>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button class="btn" onclick="app.autoScrollManager.toggle()">üîÑ Toggle Auto-Scroll</button>
            <button class="btn" onclick="app.addPersonPrompt()">+ Column</button>
            <button class="btn" onclick="app.addBlankCell()">+ Blank Slot</button>
            <button class="btn" onclick="app.showArchiveModal()">üóÉÔ∏è Archive</button>
            <button class="btn" onclick="app.showTrashModal()">üóëÔ∏è Trash</button>
          </div>
        </div>

        <div style="background:var(--bg-panel); padding:12px; border:1px solid var(--border); border-radius:6px;">
          <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:0.95rem;">Red Tag Controls</h3>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button id="settings-mode-btn" class="btn" onclick="app.toggleMode(app.state.mode === 'kanban' ? 'defects' : 'kanban')">Toggle Mode</button>
            <button class="btn" onclick="app.defectTracker.openPasteModal()">üìùPaste Dataüìù</button>
            <button class="btn" onclick="app.defectTracker.openManagePartsModal()">üî©Manage Partsüî©</button>
            <button class="btn" onclick="app.defectTracker.openManageInspectorsModal()">üëÄManage InspectorsüëÄ</button>
          </div>
        </div>

        <div style="grid-column: 1 / -1; background:var(--bg-panel); padding:12px; border:1px solid var(--border); border-radius:6px;">
          <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:0.95rem;">Work Order Management</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="document.getElementById('workorder-upload-file').click()">üìÅ Upload Excel Workbook</button>
            <button class="btn" onclick="app.workOrderManager.openManageModal()">üîß Manage Work Orders</button>
            <input type="file" id="workorder-upload-file" style="display:none" accept=".xls,.xlsx,.xlsm" onchange="app.workOrderManager.handleFileUpload(this)">
          </div>
        </div>

        <div style="grid-column: 1 / -1; background:var(--bg-panel); padding:12px; border:1px solid var(--border); border-radius:6px;">
          <h3 style="margin:0 0 8px 0; color:var(--text-main); font-size:0.95rem;">Data & Utilities</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="app.ioManager.export()">‚¨áÔ∏è Export</button>
            <button class="btn" onclick="document.getElementById('import-file').click()">‚¨ÜÔ∏è Import</button>
            <input type="file" id="import-file" style="display:none" accept=".json" onchange="app.ioManager.import(this)">
            <button class="btn" onclick="app.historyManager.undo()">Undo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- WORK ORDER MANAGEMENT MODAL -->
<div id="workorder-manage-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Work Order Database</h2>
            <div style="display:flex; gap:8px; align-items:center;">
                <span id="wo-count" style="color:var(--text-muted); font-size:0.9rem;">--</span>
                <button class="btn btn-danger" onclick="app.workOrderManager.deleteAllWorkOrders()" title="Delete all work orders">üóëÔ∏è Clear All</button>
                <button onclick="app.workOrderManager.closeManageModal()" class="btn">Close</button>
            </div>
        </div>
        <div id="workorder-table-container" class="table-container shadow-md rounded-lg border border-[var(--border)] max-h-80">
            <table class="min-w-full divide-y divide-[var(--border)]">
                <thead style="background: var(--bg-panel); position:sticky; top:0;">
                    <tr>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Work Order</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Name</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Description</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Qty</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Buildable</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem;">Actions</th>
                    </tr>
                </thead>
                <tbody id="workorder-table-body" class="min-w-full divide-y divide-[var(--border)]" style="background: var(--bg-main);">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="trash-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Trash Can üóëÔ∏è</h2>
            <button class="btn btn-danger" onclick="app.emptyTrash()">üî• EMPTY TRASH</button>
        </div>
        <div id="deleted-tasks-container"></div>
        <button class="btn" style="margin-top: 20px;" onclick="app.closeTrashModal()">Close</button>
    </div>
</div>

<div id="archive-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Archive üóÉÔ∏è</h2>
            <button class="btn btn-danger" onclick="app.clearArchive()">üóëÔ∏è ERASE ALL ARCHIVED</button>
        </div>
        <div id="archived-tasks-container"></div>
        <button class="btn" style="margin-top: 20px;" onclick="app.closeArchiveModal()">Close</button>
    </div>
</div>

<!-- ADD NC MODAL -->
<div id="add-nc-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Add New Non-Conforming (NC) Tag</h2>
            <button onclick="app.defectTracker.closeAddModal()" class="btn">Close</button>
        </div>
        <form id="new-nc-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">NC# (e.g., NC-00005) <span style="color:#ef4444;">*</span></label>
                    <input type="text" name="nc" required class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Status <span style="color:#ef4444;">*</span></label>
                    <select name="status" required class="nexus-input">
                        <option value="">Select Status</option>
                        <option value="IN PROCESS">IN PROCESS</option>
                        <option value="REPAIRED/CLOSED">REPAIRED/CLOSED</option>
                        <option value="SCRAP">SCRAP</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Part Number</label>
                    <select id="new-partNumber" name="partNumber" class="nexus-input"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Part Name</label>
                    <select id="new-partName" name="partName" class="nexus-input"></select>
                </div>
                <div>
                  <label class="block text-sm font-medium" style="color:var(--text-main);">Family (auto)</label>
                    <input type="text" name="family" id="new-family" class="nexus-input" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Serial</label>
                    <input type="text" name="serial" class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Quantity</label>
                    <input type="number" name="qty" value="1" min="1" class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Date Logged</label>
                    <input type="date" name="dateLogged" class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Inspector Initials</label>
                    <select name="inspector" class="nexus-input">
                        <option value="">Select Inspector</option>
                        <option value="TLG">TLG</option>
                        <option value="JAB">JAB</option>
                        <option value="EAC">EAC</option>
                        <option value="ETB">ETB</option>
                        <option value="JAB/EJL">JAB/EJL</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Description of Failure</label>
                <textarea name="description" rows="3" class="nexus-input" style="min-height:80px;"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Disposition/Solution</label>
                <textarea name="disposition" rows="3" class="nexus-input" style="min-height:80px;"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Notes</label>
                <textarea name="notes" rows="3" class="nexus-input" style="min-height:80px;"></textarea>
            </div>

            <div style="padding-top:16px; display:flex; justify-content:flex-end;">
                <button type="submit" class="btn btn-primary">
                    Save NC Tag
                </button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT NC MODAL -->
<div id="edit-nc-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Edit Non-Conforming (NC) Tag</h2>
            <button onclick="app.defectTracker.closeEditModal()" class="btn">Close</button>
        </div>
        <form id="edit-nc-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">NC# <span style="color:#ef4444;">*</span></label>
                    <input type="text" name="nc" required class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Status <span style="color:#ef4444;">*</span></label>
                    <select name="status" required class="nexus-input">
                        <option value="">Select Status</option>
                        <option value="IN PROCESS">IN PROCESS</option>
                        <option value="REPAIRED/CLOSED">REPAIRED/CLOSED</option>
                        <option value="SCRAP">SCRAP</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Part Number</label>
                    <select id="edit-partNumber" name="partNumber" class="nexus-input"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Part Name</label>
                    <select id="edit-partName" name="partName" class="nexus-input"></select>
                </div>
                <div>
                  <label class="block text-sm font-medium" style="color:var(--text-main);">Family (auto)</label>
                    <input type="text" name="family" id="edit-family" class="nexus-input" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Serial</label>
                    <input type="text" name="serial" class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Quantity</label>
                    <input type="number" name="qty" min="1" class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Date Logged</label>
                    <input type="date" name="dateLogged" class="nexus-input">
                </div>
                <div>
                    <label class="block text-sm font-medium" style="color:var(--text-main);">Inspector Initials</label>
                    <select name="inspector" class="nexus-input">
                        <option value="">Select Inspector</option>
                        <option value="TLG">TLG</option>
                        <option value="JAB">JAB</option>
                        <option value="EAC">EAC</option>
                        <option value="ETB">ETB</option>
                        <option value="JAB/EJL">JAB/EJL</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Description of Failure</label>
                <textarea name="description" rows="3" class="nexus-input" style="min-height:80px;"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Disposition/Solution</label>
                <textarea name="disposition" rows="3" class="nexus-input" style="min-height:80px;"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Notes</label>
                <textarea name="notes" rows="3" class="nexus-input" style="min-height:80px;"></textarea>
            </div>
            
            <div class="flex items-center space-x-6">
                <label class="flex items-center text-sm font-medium" style="color:var(--text-main);">
                    <input type="checkbox" name="ncClosed" class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded">
                    <span style="margin-left:8px;">NC Closed</span>
                </label>
                <label class="flex items-center text-sm font-medium" style="color:var(--text-main);">
                    <input type="checkbox" name="repaired" class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded">
                    <span style="margin-left:8px;">Repaired</span>
                </label>
                <label class="flex items-center text-sm font-medium" style="color:var(--text-main);">
                    <input type="checkbox" name="scrap" class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded">
                    <span style="margin-left:8px;">Scrap</span>
                </label>
            </div>

            <div style="padding-top:16px; display:flex; justify-content:flex-end;">
                <button type="submit" class="btn btn-primary">
                    Update NC Tag
                </button>
            </div>
        </form>
    </div>
</div>

<!-- PASTE DATA MODAL -->
<div id="paste-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="paste-modal-title" style="color:var(--accent);">Paste Spreadsheet Data (TSV)</h2>
            <button onclick="app.defectTracker.closePasteModal()" class="btn">Close</button>
        </div>

        <!-- Paste Data Section -->
        <div id="paste-data">
            <p style="color:var(--text-muted); margin-bottom:16px;">Copy multiple rows and columns from Excel/Google Sheets and paste them below. The system will auto-map columns.</p>
            <textarea id="paste-area" rows="8" placeholder="Paste your tab-separated spreadsheet data here..." class="nexus-input" style="font-family: monospace; font-size:0.9rem; min-height:200px;"></textarea>
            <div style="padding-top:16px; display:flex; justify-content:flex-end;">
                <button onclick="app.defectTracker.handlePasteData()" class="btn btn-primary">
                    Preview & Validate
                </button>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="paste-preview-section" class="hidden">
            <div id="paste-preview" style="margin-bottom:16px;">
                <!-- Preview table generated here -->
            </div>
            <p style="color:#ef4444; margin-bottom:16px; font-size:0.9rem;">
                <span style="font-weight:bold;">Note:</span> Rows highlighted in red have missing critical data (NC# or Status) and will be ignored during save. Existing NC#s will be overwritten/updated.
            </p>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button onclick="app.defectTracker.closePasteModal()" class="btn">
                    Cancel
                </button>
                <button id="paste-save-btn" onclick="app.defectTracker.savePastedData()" class="btn btn-primary">
                    Save Valid Records
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MANAGE PARTS MODAL -->
<div id="manage-parts-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Manage Summary Parts</h2>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button class="btn" onclick="(function(){app.defectTracker.refreshNcFamilies(); app.showToast('NC families synced.','success');})()" title="Sync families from parts to NCs">üîÅ Sync NC Families</button>
                <button class="btn" onclick="(function(){app.defectTracker.refreshAllNcDetails(); app.showToast('All NCs refreshed from parts.','success');})()" title="Refresh all NC details from parts">‚ö° Refresh ALL NCs</button>
                <button class="btn btn-danger" onclick="(function(){app.defectTracker.deleteAllNcs();})()" title="Delete all NCs">üßπ Delete ALL NCs</button>
            <button onclick="app.defectTracker.closeManagePartsModal()" class="btn">Close</button>
          </div>
        </div>
        <button onclick="app.defectTracker.openAddPartModal()" class="btn btn-primary" style="margin-bottom:16px;">+ Add New Part</button>
        <div class="table-container shadow-md rounded-lg border border-[var(--border)] max-h-60">
            <table class="min-w-full divide-y divide-[var(--border)]">
                <thead style="background: var(--bg-panel);">
                    <tr>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Part</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Part Desc.</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Family</th>
                        <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem;">Actions</th>
                    </tr>
                </thead>
                <tbody id="parts-table-body" class="min-w-full divide-y divide-[var(--border)]" style="background: var(--bg-main);">
                              <!-- Parts injected here -->
                          </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MANAGE INSPECTORS MODAL -->
<div id="manage-inspectors-modal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="color:var(--accent);">Manage Inspectors</h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <button onclick="app.defectTracker.openAddInspectorModal()" class="btn btn-primary">+ Add Inspector</button>
        <button onclick="app.defectTracker.closeManageInspectorsModal()" class="btn">Close</button>
      </div>
    </div>
    <div class="table-container shadow-md rounded-lg border border-[var(--border)] max-h-60">
      <table class="min-w-full divide-y divide-[var(--border)]">
        <thead style="background: var(--bg-panel);">
          <tr>
            <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem; border-right:1px solid var(--border);">Initials</th>
            <th style="padding:10px; text-align:left; color:var(--accent); font-weight:800; font-size:0.9rem;">Actions</th>
          </tr>
        </thead>
        <tbody id="inspectors-table-body" class="min-w-full divide-y divide-[var(--border)]" style="background: var(--bg-main);">
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ADD INSPECTOR MODAL -->
<div id="add-inspector-modal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="color:var(--accent);">Add Inspector</h2>
      <button onclick="app.defectTracker.closeAddInspectorModal()" class="btn">Close</button>
    </div>
    <form id="add-inspector-form" onsubmit="app.defectTracker.handleAddInspector(event)">
      <div>
        <label class="block text-sm font-medium" style="color:var(--text-main);">Inspector Initials <span style="color:#ef4444;">*</span></label>
        <input type="text" name="initials" required class="nexus-input" maxlength="12">
      </div>
      <div style="padding-top:16px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="app.defectTracker.closeAddInspectorModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT INSPECTOR MODAL -->
<div id="edit-inspector-modal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="color:var(--accent);">Edit Inspector</h2>
      <button onclick="app.defectTracker.closeEditInspectorModal()" class="btn">Close</button>
    </div>
    <form id="edit-inspector-form" onsubmit="app.defectTracker.handleEditInspector(event)">
      <input type="hidden" name="original" value="">
      <div>
        <label class="block text-sm font-medium" style="color:var(--text-main);">Inspector Initials <span style="color:#ef4444;">*</span></label>
        <input type="text" name="initials" required class="nexus-input" maxlength="12">
      </div>
      <div style="padding-top:16px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="app.defectTracker.closeEditInspectorModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- ADD PART MODAL -->
<div id="add-part-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Add New Part</h2>
            <button onclick="app.defectTracker.closeAddPartModal()" class="btn">Close</button>
        </div>
        <form id="add-part-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Part <span style="color:#ef4444;">*</span></label>
                <input type="text" name="partNumber" required class="nexus-input">
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Part Desc. <span style="color:#ef4444;">*</span></label>
                <input type="text" name="partName" required class="nexus-input">
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Family <span style="color:#ef4444;">*</span></label>
                <input type="text" name="family" required class="nexus-input">
            </div>
            <div style="padding-top:16px; display:flex; justify-content:flex-end;">
                <button type="submit" class="btn btn-primary">
                    Save Part
                </button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT PART MODAL -->
<div id="edit-part-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Edit Part</h2>
            <button onclick="app.defectTracker.closeEditPartModal()" class="btn">Close</button>
        </div>
        <form id="edit-part-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Part <span style="color:#ef4444;">*</span></label>
                <input type="text" name="partNumber" required class="nexus-input">
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Part Desc. <span style="color:#ef4444;">*</span></label>
                <input type="text" name="partName" required class="nexus-input">
            </div>
            <div>
                <label class="block text-sm font-medium" style="color:var(--text-main);">Family <span style="color:#ef4444;">*</span></label>
                <input type="text" name="family" required class="nexus-input">
            </div>
            <div style="padding-top:16px; display:flex; justify-content:flex-end;">
                <button type="submit" class="btn btn-primary">
                    Update Part
                </button>
            </div>
        </form>
    </div>
</div>

<!-- REPORTS MODAL -->
<div id="reports-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--accent);">Red Tag Reports</h2>
            <button onclick="app.defectTracker.closeReportsModal()" class="btn">Close</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <label class="flex items-center">
                <input type="checkbox" checked class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" onchange="app.defectTracker.toggleGraph('status')">
                <span style="margin-left:8px; color:var(--text-main);">Status Summary</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" checked class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" onchange="app.defectTracker.toggleGraph('qtyByPart')">
                <span style="margin-left:8px; color:var(--text-main);">Quantity by Part</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" checked class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" onchange="app.defectTracker.toggleGraph('qtyByStatus')">
                <span style="margin-left:8px; color:var(--text-main);">Quantity by Status</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" checked class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" onchange="app.defectTracker.toggleGraph('qtyByFamily')">
                <span style="margin-left:8px; color:var(--text-main);">Quantity by Family</span>
            </label>
        </div>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
          <label style="color:var(--text-main); font-weight:700; margin-right:8px;">Status Filters</label>
          <label class="flex items-center" style="gap:6px;">
            <input type="checkbox" class="report-status-checkbox h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" value="REPAIRED/CLOSED" checked>
            <span style="color:var(--text-main);">Repaired/Closed</span>
          </label>
          <label class="flex items-center" style="gap:6px;">
            <input type="checkbox" class="report-status-checkbox h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" value="SCRAP" checked>
            <span style="color:var(--text-main);">Scrap</span>
          </label>
          <label class="flex items-center" style="gap:6px;">
            <input type="checkbox" class="report-status-checkbox h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" value="IN PROCESS" checked>
            <span style="color:var(--text-main);">In Process</span>
          </label>
          <label class="flex items-center" style="gap:6px;">
            <input type="checkbox" id="report-status-all" class="h-4 w-4 text-[var(--accent)] border-[var(--border)] rounded" checked>
            <span style="color:var(--text-main);">All</span>
          </label>
        </div>
        <div class="report-controls" style="margin-bottom:12px;">
          <label style="color:var(--text-main); font-weight:700;">Group By</label>
          <select id="report-groupby" class="nexus-input" style="width:160px;">
            <option value="family">Family</option>
            <option value="partNumber">Part Number</option>
            <option value="partName">Part Name</option>
            <option value="status">Status</option>
            <option value="inspector">Inspector</option>
            <option value="dateLogged">Date Logged</option>
            <option value="month">Month (Trend)</option>
            <option value="monthByFamily">Month by Family</option>
            <option value="monthByStatus">Month by Status</option>
          </select>
          <label style="color:var(--text-main); font-weight:700;">Metric</label>
          <select id="report-metric" class="nexus-input" style="width:140px;">
            <option value="count">Count (records)</option>
            <option value="qty">Quantity (sum)</option>
            <option value="avgQty">Avg Qty</option>
          </select>
          <label style="color:var(--text-main); font-weight:700;">Visualization</label>
          <select id="report-viz" class="nexus-input" style="width:140px;">
            <option value="bar">Bar Chart</option>
            <option value="line">Line (Trend)</option>
            <option value="pie">Pie/Donut</option>
            <option value="table">Table</option>
          </select>
          <label style="color:var(--text-main); font-weight:700;">From</label>
          <input id="report-from" type="date" class="nexus-input" style="width:140px;" />
          <label style="color:var(--text-main); font-weight:700;">To</label>
          <input id="report-to" type="date" class="nexus-input" style="width:140px;" />
          <button id="report-generate" class="btn btn-primary">Generate</button>
          <button id="report-export" class="btn" title="Export current view as CSV">Export CSV</button>
          <button id="report-full" class="btn" title="Toggle fullscreen chart" onclick="app.defectTracker.toggleReportFullscreen()">‚§¢ Expand</button>
        </div>

        <div id="reports-content" style="color:var(--text-main);">
          <!-- Reports injected here -->
        </div>
    </div>
</div>

<!-- RED TAG TRASH MODAL -->
<div id="red-tag-trash-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:var(--accent);">Red Tag Trash üóëÔ∏è</h2>
            <button class="btn btn-danger" onclick="app.defectTracker.emptyTrash()">üî• EMPTY TRASH</button>
        </div>
        <div id="red-tag-deleted-container"></div>
        <button class="btn" style="margin-top: 20px;" onclick="app.defectTracker.closeTrashModal()">Close</button>
    </div>
</div>

<script>
  // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC8XXCR4QcKoJchOcuZTKv5IgQdi5BMPb8",
  authDomain: "clarity-c6f22.firebaseapp.com",
  projectId: "clarity-c6f22",
  storageBucket: "clarity-c6f22.firebasestorage.app",
  messagingSenderId: "697756603956",
  appId: "1:697756603956:web:09716303bfa99759fddc61",
  measurementId: "G-L9BQE7BZJP"
};

// Initialize Firebase using the Compat/Namespaced style
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/**
 * CLARITY // CORE ENGINE 1.0
 * Built on the foundation of Project Nexus 4.3.1
 * Focus: Stability, Modernization, "Bulletproof" Logic
 */

class ClarityApp {
  constructor() {
   this.syncUnsubscribe = null;
    // Indicates the app has completed its initial realtime load and is safe to write cloud updates
    this.initialized = false;
    // 1. We keep the basic structure, but start with empty arrays
    this.state = {
      columns: [], 
      tasks: [],
      theme: 'core',
      filter: '',
      mode: 'kanban' 
    };

    // Load persisted theme from localStorage (per-user setting)
    try {
      const savedTheme = localStorage.getItem('clarity_theme');
      if (savedTheme) {
        this.state.theme = savedTheme;
        try { document.documentElement.setAttribute('data-theme', savedTheme); } catch(e) {}
      }
    } catch (e) { /* ignore storage errors */ }

    // 2. Setup the internal managers
    this.historyManager = new HistoryManager(this);
    this.ioManager = new IOManager(this);
    this.autoScrollManager = new AutoScrollManager(); 
    this.defectTracker = new DefectTracker(this);
    this.workOrderManager = new WorkOrderManager(this);
    
    // 3. IMPORTANT: Notice we REMOVED this.init() and migrationCheck().
    // We don't want the app to "start" until the login is successful.
    
    // 4. Set up the event listeners so buttons like "Add Task" work later
    if (this.initEventListeners) this.initEventListeners();
  }
login() {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;

    // We call the Firebase Auth library
    auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
            // SUCCESS: Hide the login overlay
            const overlay = document.getElementById('login-overlay');
            if (overlay) overlay.style.display = 'none';
            
            // Now start the live data sync (Step C)
            this.initRealtimeSync(); 
            this.showToast("Access Granted", "success");
        })
        .catch(error => {
            // FAILURE: Show the error message on the screen
            const errorEl = document.getElementById('login-error');
            if (errorEl) errorEl.textContent = error.message;
            console.error("Login failed:", error.message);
        });
  }
 initRealtimeSync() {
    // 1. Safety check: If we are already listening, don't start a second one
    if (this.syncUnsubscribe) return;

    // 2. Start the "Live Connection" and save the "Hang Up" button to this.syncUnsubscribe
    this.syncUnsubscribe = db.collection('appData').doc('main').onSnapshot((doc) => {
        if (doc.exists) {
            const data = doc.data();
            
            // 3. Update the CONTENT (Tasks and Columns)
            this.state.columns = data.columns || ["Alpha", "Beta", "Gamma", "BLANK", "BLANK"];
            this.state.tasks = this.sanitizeTasks(data.tasks || []);
            
            // 4. Update Defect Tracker data if it exists
            if (this.defectTracker) {
                this.defectTracker.redTags = this.defectTracker.sanitizeRedTags(data.redTags || []);
                this.defectTracker.summaryParts = data.summaryParts || [];
            }

            // 4b. Update Work Order data if it exists
            if (this.workOrderManager) {
                this.workOrderManager.workOrders = data.workOrders || [];
            }

            // NOTE: We skip 'theme' and 'mode' here so your screen doesn't 
            // change just because someone else changed theirs.

            // 5. Refresh the screen based on which mode YOU are currently in
            if (this.state.mode === 'kanban') {
                this.renderBoard();
            } else if (this.defectTracker) {
                this.defectTracker.render();
            }
            
            this.showToast("Cloud Synced", "success");
        } else {
            // If the database is empty, create the first save
            this.saveState();
        }
          // Mark app as initialized after we processed the first snapshot (prevents accidental early writes)
          if (!this.initialized) this.initialized = true;
    });
}
  // --- MIGRATION & SANITIZATION (STABILITY) ---
  
  migrationCheck() {
    // Detects if user has old Nexus data but no Clarity data
    if (!localStorage.getItem('clarity_tasks') && localStorage.getItem('tasks')) {
        console.log("CLARITY: Migrating legacy data...");
        localStorage.setItem('clarity_tasks', localStorage.getItem('tasks'));
        localStorage.setItem('clarity_columns', localStorage.getItem('gridCells'));
        localStorage.setItem('clarity_theme', localStorage.getItem('theme'));
        // Optional: clear old data? Better to keep as backup for now.
    }
  }

  // UPGRADE: Ensure loaded tasks have all required fields (Self-Healing)
  sanitizeTasks(tasks) {
    if (!Array.isArray(tasks)) return [];
    return tasks.map(t => ({
        id: t.id || crypto.randomUUID(),
        person: t.person || 'Unassigned',
        title: t.title || 'Untitled',
        date: t.date || new Date().toISOString().split('T')[0],
        status: t.status || 'none',
        priority: t.priority || 'medium',
        notes: t.notes || '',
        tags: t.tags || [],
        workOrder: t.workOrder || '', // NEW: Work order field
        sortOrder: t.sortOrder !== undefined ? t.sortOrder : Date.now(),
        deleted: t.deleted === true,
        archived: t.archived === true, 
        archiveTimestamp: t.archiveTimestamp || null 
    }));
  }

  init() {
    this.setTheme(this.state.theme);
    this.toggleMode(this.state.mode);
    this.setupGlobalListeners();
    this.showToast("CLARITY 1.0 ONLINE");
  }

  toggleMode(mode) {
    this.state.mode = mode;
    const board = document.getElementById('board-canvas');
    const defects = document.getElementById('defect-tracker-view');
    const searchInput = document.getElementById('search-input');
    const kanbanOnly = document.querySelectorAll('.kanban-only');
    const redTagOnly = document.querySelectorAll('.red-tag-only');

    if (mode === 'defects') {
      board.style.display = 'none';
      defects.style.display = 'block';
      searchInput.placeholder = "Filter red tags...";
      searchInput.oninput = (e) => this.defectTracker.handleSearch(e.target.value);
      kanbanOnly.forEach(el => el.style.display = 'none');
      redTagOnly.forEach(el => el.style.display = 'inline-block');
      this.defectTracker.render();
    } else {
      board.style.display = 'grid';
      defects.style.display = 'none';
      searchInput.placeholder = "Filter tasks...";
      searchInput.oninput = (e) => this.handleSearch(e.target.value);
      kanbanOnly.forEach(el => el.style.display = 'inline-block');
      redTagOnly.forEach(el => el.style.display = 'none');
      this.renderBoard();
    }
    // Auto-close settings modal if open when mode changes
    document.getElementById('hud-settings-modal')?.classList.remove('visible');
    this.saveState();
  }

  // --- CORE UTILITIES ---
  
  getLocalDate() {
    const d = new Date();
    return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  }

  getLocalDateTime() {
    const now = new Date();
    const date = now.toISOString().split('T')[0];
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    return `${date} ${time}`;
  }

  // Prevents XSS attacks in titles
  escapeHtml(text) {
    if (!text) return text;
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  _sanitizeId(name) {
    if (name === 'BLANK') return 'BLANK';
    return name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
  }

  // --- STATE MANAGEMENT ---
  
  saveState() {
    // 1. Package all current app data into one object
    const dataToSave = {
      columns: this.state.columns,
      tasks: this.state.tasks,
      // We also include the Defect Tracker data so everything stays in sync
      redTags: this.defectTracker ? this.defectTracker.redTags : [],
      summaryParts: this.defectTracker ? this.defectTracker.summaryParts : [],
      workOrders: this.workOrderManager ? this.workOrderManager.workOrders : []
    };

    // 2. Upload to Firestore
    // .set with {merge: true} is the safest way to update the document
    db.collection('appData').doc('main').set(dataToSave, { merge: true })
      .then(() => {
        console.log("Cloud update successful");
      })
      .catch((error) => {
        console.error("Cloud save error:", error);
        this.showToast("Save Failed: " + error.message, "error");
      });
  }
updateTask(id, changes) {
    this.historyManager.push();

    const task = this.state.tasks.find(t => t.id === id);
    if (!task) {
      console.warn('Task not found for update:', id);
      return;
    }

    // Apply the changes
    Object.assign(task, changes);

    // Save and re-render
    this.saveState();
    this.renderBoard();

    this.showToast("Task updated");
  }

  addTask(person, title) {
    if (!title.trim()) return;
    this.historyManager.push();
    
    // UPGRADE: Smart Tag parsing (e.g. "Buy Milk #urgent")
    let tags = [];
    let cleanTitle = title;
    /* Simple tag extractor: looks for words starting with #
       Note: You can enable this if you want hashtag support in quick add. 
       For now, we'll keep it simple as requested.
    */

    const newTask = {
      id: crypto.randomUUID(),
      person: person,
      title: cleanTitle,
      date: this.getLocalDate(),
      status: 'none',
      priority: 'medium',
      notes: '',
      tags: [],
      workOrder: '', // NEW: Initialize empty work order
      sortOrder: Date.now(),
      deleted: false,
      archived: false,
      archiveTimestamp: null 
    };

    this.state.tasks.push(newTask);
    this.saveState();
    this.renderBoard(person); 
    this.showToast("Task Created");
  }

  deleteTask(id) {
    this.historyManager.push();
    const task = this.state.tasks.find(t => t.id === id);
    if (task) {
        task.deleted = true; 
        task.archived = false; 
        task.archiveTimestamp = null;
        this.saveState();
        this.renderBoard(); 
        this.showToast("Moved to Trash üóëÔ∏è");
    }
  }
  
  archiveTask(id) {
    this.historyManager.push();
    const task = this.state.tasks.find(t => t.id === id);
    if (task) {
        task.archived = true;
        task.archiveTimestamp = new Date().toISOString();
        task.deleted = false; 
        this.saveState();
        this.renderBoard();
        this.showToast("Archived üóÉÔ∏è");
    }
  }

  restoreTask(id, source) {
    this.historyManager.push();
    const task = this.state.tasks.find(t => t.id === id);
    if (!task) return;
    
    task.deleted = false;
    task.archived = false;
    task.archiveTimestamp = null;
    
    // Safety: Check if column still exists
    const activeCols = this.state.columns.filter(c => c !== 'BLANK');
    if (!activeCols.includes(task.person) && activeCols.length > 0) {
        task.person = activeCols[0];
        this.showToast(`Restored to ${activeCols[0]}`);
    } else {
        this.showToast("Restored!");
    }
    
    this.saveState();
    this.renderBoard();
    if (source === 'trash') this.showTrashModal();
    if (source === 'archive') this.showArchiveModal();
  }

  permanentDeleteTask(id, source) {
    if(!confirm("Permanently destroy this task?")) return;
    this.historyManager.push();
    this.state.tasks = this.state.tasks.filter(t => t.id !== id);
    this.saveState();
    this.renderBoard();
    if (source === 'trash') this.showTrashModal();
    if (source === 'archive') this.showArchiveModal();
  }
  
  emptyTrash() {
    if (this.state.tasks.filter(t => t.deleted).length === 0) return this.showToast("Trash is empty");
    if(!confirm("Destroy ALL trash items?")) return;
    this.historyManager.push();
    this.state.tasks = this.state.tasks.filter(t => !t.deleted);
    this.saveState();
    this.showTrashModal(); 
    this.showToast("Trash Empty");
  }
  
  clearArchive() {
    if (this.state.tasks.filter(t => t.archived).length === 0) return this.showToast("Archive is empty");
    if(!confirm("Destroy ALL archived items?")) return;
    this.historyManager.push();
    this.state.tasks = this.state.tasks.filter(t => !t.archived);
    this.saveState();
    this.showArchiveModal();
    this.showToast("Archive Cleared");
  }

  saveAndCollapseTaskCard(id) {
    const titleInput = document.getElementById(`title-edit-${id}`);
    const notesTextarea = document.getElementById(`notes-${id}`);
    const tagsInput = document.getElementById(`tags-${id}`);
    const card = titleInput ? titleInput.closest('.task-card') : null;
    
    if (!card) return;

    this.historyManager.push();
    
    // UPGRADE: Process tags
    const tagArray = tagsInput.value.split(',').map(s => s.trim()).filter(s => s !== "");

    this.updateTask(id, { 
        title: titleInput.value, 
        notes: notesTextarea.value,
        tags: tagArray
    });

    card.classList.remove('expanded');
    this.showToast("Saved");
    this.renderBoard();
  }

  // Focus the title edit input and set caret position based on click within the visible title
  focusTitle(id, e) {
    const card = document.getElementById(`title-edit-${id}`) ? document.getElementById(`title-edit-${id}`).closest('.task-card') : null;
    if(!card) return;
    // Expand the card
    card.classList.add('expanded');

    // Wait a tick so input exists in DOM
    setTimeout(() => {
      const input = document.getElementById(`title-edit-${id}`);
      if (!input) return;
      input.focus();

      // Calculate approximate caret index based on click X over visible title text
      try {
        const titleDiv = e.currentTarget || e.target;
        const rect = titleDiv.getBoundingClientRect();
        const clickX = (e.clientX || 0) - rect.left;
        const text = titleDiv.textContent || '';
        // Adjust for input padding (12px left, 12px right)
        const inputPaddingLeft = 12;
        const inputPaddingRight = 12;
        const effectiveWidth = rect.width - inputPaddingLeft - inputPaddingRight;
        const effectiveClickX = Math.max(0, clickX - inputPaddingLeft);
        const frac = Math.max(0, Math.min(1, effectiveClickX / Math.max(1, effectiveWidth)));
        const idx = Math.round(frac * text.length);
        input.setSelectionRange(idx, idx);
      } catch (err) { /* safe-fail */ }
    }, 50); // Increased timeout for better DOM update
  }

  // Column editor: open an inline editor for bulk actions (wipe, date, status, duplicate)
  openColumnEditor(name, event) {
    // Close any existing editor first
    this.closeColumnEditor();

    const sanitized = this._sanitizeId(name);
    const editor = document.getElementById(`col-editor-${sanitized}`);
    if(!editor) return;

    editor.classList.remove('hidden');
    editor.setAttribute('aria-hidden', 'false');
    editor.innerHTML = `
      <div style="padding:10px; background: #fff6d6; border:1px solid #e6dba8; border-radius:6px;">
        <div style="font-weight:800; margin-bottom:8px;">Edit Column: ${this.escapeHtml(name)}</div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input id="col-name-${sanitized}" class="nexus-input" style="flex:1;" value="${this.escapeHtml(name)}">
          <button class="btn" onclick="app.renameColumn('${name}')">Rename</button>
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:600; margin-bottom:4px;">Bulk Status Update:</div>
          <div style="display:flex; gap:4px; flex-wrap:wrap;">
            <button class="btn btn-sm" onclick="app.bulkUpdateColumnStatus('${name}', 'none')">Pending</button>
            <button class="btn btn-sm" onclick="app.bulkUpdateColumnStatus('${name}', 'inprocess')">In Process</button>
            <button class="btn btn-sm" onclick="app.bulkUpdateColumnStatus('${name}', 'offline')">Blocked</button>
            <button class="btn btn-sm" onclick="app.bulkUpdateColumnStatus('${name}', 'complete')">Complete</button>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <input type="date" class="nexus-input" id="col-date-${sanitized}" style="flex:1;" placeholder="Leave empty to keep dates">
          <select class="nexus-input" id="col-status-${sanitized}" style="width:160px;">
            <option value="none">Pending</option>
            <option value="inprocess">In Process</option>
            <option value="offline">Blocked</option>
            <option value="complete">Complete</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <button class="btn" onclick="app.copyColumn('${name}')" style="flex:1;">Copy</button>
          <button class="btn" onclick="app.pasteIntoColumn('${name}')" style="flex:1;">Paste</button>
          <button class="btn" onclick="app.duplicateColumn('${name}')" style="flex:1;">Duplicate</button>
          <button class="btn" onclick="app.printColumn('${name}')" style="flex:1;">Print</button>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-danger" onclick="app.wipeColumn('${name}')" style="flex:1;">Wipe Column</button>
          <button class="btn" onclick="app.removePerson('${name}')" style="flex:1;">Delete Column</button>
        </div>
      </div>
    `;

    // highlight column visually
    const colEl = event ? event.currentTarget.closest('.column') : document.querySelector(`.column[data-person="${name}"]`);
    if(colEl) colEl.classList.add('editing');

    // Close editor when clicking outside
    this._colEditorListener = (ev) => {
      const target = ev.target;
      if (!editor.contains(target) && (!colEl || !colEl.contains(target))) {
        // Apply date/status changes if provided
        const dateInput = document.getElementById(`col-date-${sanitized}`);
        const statusInput = document.getElementById(`col-status-${sanitized}`);
        if(dateInput && dateInput.value) {
          this.historyManager.push();
          this.state.tasks.forEach(t => { if(t.person === name) t.date = dateInput.value; });
        }
        if(statusInput && statusInput.value) {
          this.historyManager.push();
          this.state.tasks.forEach(t => { if(t.person === name) t.status = statusInput.value; });
        }
        this.closeColumnEditor();
        this.saveState();
        this.renderBoard();
      }
    };

    document.addEventListener('click', this._colEditorListener);
  }

  closeColumnEditor() {
    const open = document.querySelector('.column-editor:not(.hidden)');
    if(open) {
      const col = open.closest('.column');
      if(col) col.classList.remove('editing');
      open.classList.add('hidden');
      open.setAttribute('aria-hidden','true');
      open.innerHTML = '';
    }
    if (this._colEditorListener) {
      document.removeEventListener('click', this._colEditorListener);
      this._colEditorListener = null;
    }
  }

  bulkUpdateColumnStatus(name, status) {
    this.historyManager.push();
    this.state.tasks.forEach(t => { if(t.person === name && !t.deleted && !t.archived) t.status = status; });
    this.saveState();
    this.showToast(`All tasks in ${name} set to ${status}`);
    this.closeColumnEditor();
    this.renderBoard();
  }

  wipeColumn(name) {
    if(!confirm(`Delete ALL tasks in column "${name}"?`)) return;
    this.historyManager.push();
    this.state.tasks.forEach(t => { if (t.person === name) t.deleted = true; });
    this.saveState();
    this.showToast(`Wiped ${name}`);
    this.renderBoard();
  }

  duplicateColumn(name) {
    const newName = prompt('Duplicate column as:', `${name} Copy`);
    if(!newName || !newName.trim()) return;
    if (this.state.columns.includes(newName.trim())) return this.showToast('Exists already','error');
    this.historyManager.push();
    this.state.columns.push(newName.trim());
    const tasksToDup = this.state.tasks.filter(t => t.person === name && !t.deleted && !t.archived);
    tasksToDup.forEach(t => {
      const dup = Object.assign({}, t, { id: crypto.randomUUID(), person: newName.trim(), sortOrder: Date.now() + Math.floor(Math.random()*1000) });
      this.state.tasks.push(dup);
    });
    this.saveState();
    this.renderBoard(newName.trim());
    this.showToast('Column duplicated');
  }

  async copyColumn(name) {
    try {
      const data = this.state.tasks.filter(t => t.person === name && !t.deleted && !t.archived);
      await navigator.clipboard.writeText(JSON.stringify(data));
      this.showToast('Column copied to clipboard');
    } catch (err) { this.showToast('Clipboard not available','error'); }
  }

  async pasteIntoColumn(name) {
    try {
      const text = await navigator.clipboard.readText();
      if(!text) return this.showToast('Clipboard empty','error');
      const parsed = JSON.parse(text);
      if(!Array.isArray(parsed)) return this.showToast('Invalid clipboard data','error');
      this.historyManager.push();
      parsed.forEach(item => {
        const dup = Object.assign({}, item, { id: crypto.randomUUID(), person: name, sortOrder: Date.now() + Math.floor(Math.random()*1000) });
        this.state.tasks.push(dup);
      });
      this.saveState();
      this.renderBoard(name);
      this.showToast('Pasted into column');
    } catch (err) { console.error(err); this.showToast('Paste failed','error'); }
  }

  printColumn(name) {
    const tasks = this.state.tasks.filter(t => t.person === name && !t.deleted && !t.archived);
    if (tasks.length === 0) {
      this.showToast('No tasks to print', 'error');
      return;
    }

    // Create a new window for printing
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    if (!printWindow) {
      this.showToast('Popup blocked, allow popups for printing', 'error');
      return;
    }

    const today = this.getLocalDate();
    let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>${this.escapeHtml(name)} - Task Column</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
          .task-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 4px; }
          .task-title { font-weight: bold; margin-bottom: 5px; }
          .task-details { font-size: 0.9em; color: #666; }
          .date-header { font-weight: bold; margin: 20px 0 10px 0; color: #333; }
          .status-pending { border-left: 4px solid #ffa500; }
          .status-inprocess { border-left: 4px solid #007bff; }
          .status-offline { border-left: 4px solid #dc3545; }
          .status-complete { border-left: 4px solid #28a745; }
          @media print {
            body { margin: 0; }
            .task-card { page-break-inside: avoid; }
          }
        </style>
      </head>
      <body>
        <h1>${this.escapeHtml(name)} - Task Column (${tasks.length} tasks)</h1>
        <p>Printed on ${today}</p>
    `;

    let lastDate = null;
    tasks.sort((a, b) => {
      if (a.date !== b.date) return a.date.localeCompare(b.date);
      return a.sortOrder - b.sortOrder;
    });

    tasks.forEach(task => {
      if (task.date !== lastDate) {
        const displayDate = task.date === today ? "TODAY" : task.date;
        html += `<div class="date-header">${displayDate}</div>`;
        lastDate = task.date;
      }

      const statusClass = task.status ? `status-${task.status}` : '';
      html += `
        <div class="task-card ${statusClass}">
          <div class="task-title">${this.escapeHtml(task.title)}</div>
          <div class="task-details">
            <strong>Status:</strong> ${task.status === 'none' ? 'Pending' : task.status === 'inprocess' ? 'In Process' : task.status === 'offline' ? 'Blocked' : task.status === 'complete' ? 'Complete' : task.status}<br>
            <strong>Priority:</strong> ${task.priority === 'high' ? 'High' : task.priority === 'medium' ? 'Medium' : 'Low'}<br>
            ${task.notes ? `<strong>Notes:</strong> ${this.escapeHtml(task.notes)}` : ''}
          </div>
        </div>
      `;
    });

    html += `
      </body>
      </html>
    `;

    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    this.closeColumnEditor();
  }

  renameColumn(oldName) {
    const input = document.getElementById(`col-name-${this._sanitizeId(oldName)}`);
    if(!input) return;
    const newName = input.value.trim();
    if(!newName || newName === oldName) return;
    if(this.state.columns.includes(newName)) return this.showToast('Exists already','error');
    this.historyManager.push();
    const idx = this.state.columns.indexOf(oldName);
    if(idx !== -1) this.state.columns[idx] = newName;
    this.state.tasks.forEach(t => { if(t.person === oldName) t.person = newName; });
    this.saveState();
    this.closeColumnEditor();
    this.renderBoard(newName);
    this.showToast('Renamed');
  }

  // --- MODALS ---
  
  showTrashModal() {
    this.autoScrollManager.pauseForInteraction(); 
    const container = document.getElementById('deleted-tasks-container');
    const tasks = this.state.tasks.filter(t => t.deleted); 
    this._renderListModal(container, tasks, 'trash');
    document.getElementById('trash-modal').classList.add('visible');
  }
  
  showArchiveModal() {
    this.autoScrollManager.pauseForInteraction(); 
    const container = document.getElementById('archived-tasks-container');
    const tasks = this.state.tasks.filter(t => t.archived);
    // Group by column for archive
    container.innerHTML = tasks.length === 0 ? '<p style="color:var(--text-muted); text-align:center;">Empty.</p>' : '';
    if (tasks.length > 0) {
        const groups = tasks.reduce((acc, t) => { (acc[t.person] = acc[t.person] || []).push(t); return acc; }, {});
        Object.keys(groups).sort().forEach(person => {
            const header = document.createElement('div');
            header.className = 'archive-group-header';
            header.innerHTML = `<span>${person} (${groups[person].length})</span><span class="chevron">&#9660;</span>`;
            header.onclick = (e) => this.toggleArchiveGroup(e.currentTarget);
            container.appendChild(header);
            
            const content = document.createElement('div');
            content.className = 'archive-group-content';
            this._renderListItems(content, groups[person], 'archive');
            container.appendChild(content);
        });
    }
    document.getElementById('archive-modal').classList.add('visible');
  }
  
  _renderListModal(container, tasks, type) {
    container.innerHTML = tasks.length === 0 ? '<p style="color:var(--text-muted); text-align:center;">Empty.</p>' : '';
    this._renderListItems(container, tasks, type);
  }

  _renderListItems(container, tasks, type) {
    tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = type === 'trash' ? 'trash-card' : 'archive-card';
        div.innerHTML = `
          <div style="flex-grow: 1;">
            <div style="font-weight: 700; color: var(--text-main);">${this.escapeHtml(task.title)}</div>
            <div class="trash-meta">${task.person} | ${task.date}</div>
          </div>
          <button class="btn btn-primary" onclick="app.restoreTask('${task.id}', '${type}')">RESTORE</button>
          <button class="btn" onclick="app.permanentDeleteTask('${task.id}', '${type}')">DEL</button>
        `;
        container.appendChild(div);
    });
  }

  toggleArchiveGroup(header) {
    const content = header.nextElementSibling;
    const chevron = header.querySelector('.chevron');
    content.classList.toggle('collapsed');
    chevron.innerHTML = content.classList.contains('collapsed') ? '&#9658;' : '&#9660;';
  }

  closeTrashModal() { document.getElementById('trash-modal').classList.remove('visible'); }
  closeArchiveModal() { document.getElementById('archive-modal').classList.remove('visible'); }

  // --- COLUMN MANAGEMENT ---

  addPersonPrompt() {
    const name = prompt("Column Name:");
    if (!name || !name.trim()) return;
    if (this.state.columns.includes(name.trim())) return this.showToast("Exists already", "error");
    
    this.historyManager.push();
    const blankIdx = this.state.columns.indexOf("BLANK");
    if (blankIdx !== -1) this.state.columns[blankIdx] = name.trim();
    else this.state.columns.push(name.trim());
    
    this.saveState();
    this.renderBoard();
  }

  editColumnName(oldName) {
    const newName = prompt("Rename to:", oldName);
    if (!newName || !newName.trim() || newName === oldName) return;
    if (this.state.columns.includes(newName.trim())) return this.showToast("Exists already", "error");

    this.historyManager.push();
    const idx = this.state.columns.indexOf(oldName);
    if (idx !== -1) this.state.columns[idx] = newName.trim();
    this.state.tasks.forEach(t => { if (t.person === oldName) t.person = newName.trim(); });
    
    this.saveState();
    this.renderBoard();
  }

  removePerson(name) {
    if(!confirm(`Delete column "${name}"? Tasks will move to Trash.`)) return; 
    this.historyManager.push();
    this.state.tasks.forEach(t => { if (t.person === name) t.deleted = true; });
    this.state.columns = this.state.columns.map(c => c === name ? "BLANK" : c);
    this.saveState();
    this.renderBoard();
  }
  
  addBlankCell() {
    this.state.columns.push("BLANK");
    this.saveState();
    this.renderBoard();
  }
  
  removeBlankCell(index) {
    this.state.columns.splice(index, 1);
    this.saveState();
    this.renderBoard();
  }

  // --- UI ACTIONS ---

  setTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
    this.state.theme = themeName;
    try { localStorage.setItem('clarity_theme', themeName); } catch(e) {}
    this.saveState();
    if (this.state.mode === 'defects') this.defectTracker.render();
  }

  toggleHud() {
    document.getElementById('hud-container').classList.toggle('collapsed');
    const btn = document.getElementById('hud-toggle');
    btn.textContent = document.getElementById('hud-container').classList.contains('collapsed') ? "SHOW CONTROLS" : "HIDE CONTROLS";
  }

  openHudSettingsModal() {
    const modal = document.getElementById('hud-settings-modal');
    if (!modal) return;
    const modeBtn = document.getElementById('settings-mode-btn');
    if (modeBtn) {
      modeBtn.textContent = this.state.mode === 'kanban' ? 'üö®Switch to Red Tag Modeüö®' : 'Switch to Kanban Mode';
    }
    modal.classList.add('visible');
    // Close modal when user clicks outside the content area
    modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('visible'); };
  }

  handleSearch(val) {
    this.state.filter = val.toLowerCase();
    if (this.searchTimeout) clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => this.renderBoard(), 100);
  }

  showToast(msg, type='info') {
    const el = document.getElementById('toast');
    el.textContent = `>> ${msg}`;
    el.style.borderLeftColor = type === 'error' ? 'var(--status-offline-border)' : 'var(--accent)';
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 2500);
  }

  // --- RENDERING ENGINE (MODERNIZED) ---

  renderBoard(focusOnColumn = null) {
    // Close any open inline editors to avoid stale listeners
    if (typeof this.closeColumnEditor === 'function') this.closeColumnEditor();
    const board = document.getElementById('board-canvas');
    board.innerHTML = '';
    const today = this.getLocalDate();

    this.state.columns.forEach((colName, index) => {
      // 1. BLANK SLOT
      if (colName === "BLANK") {
        const blank = document.createElement('div');
        blank.className = 'grid-blank-cell';
        blank.innerHTML = `<button class="btn remove-blank-btn" onclick="app.removeBlankCell(${index})">X</button>`;
        board.appendChild(blank);
        return;
      }
      
      // 2. ACTIVE COLUMN
      const sanitizedId = this._sanitizeId(colName);
      let tasks = this.state.tasks.filter(t => t.person === colName && !t.deleted && !t.archived);
      
      if (this.state.filter) {
        tasks = tasks.filter(t => t.title.toLowerCase().includes(this.state.filter) || 
                                  t.notes.toLowerCase().includes(this.state.filter) ||
                                  (t.tags && t.tags.some(tag => tag.toLowerCase().includes(this.state.filter))));
      }

      // Sorting: Custom Order -> Date -> Priority
      tasks.sort((a, b) => {
        if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return 0; 
      });

      const colDiv = document.createElement('div');
      colDiv.className = 'column';
      colDiv.dataset.person = colName; 

      colDiv.innerHTML = `
        <div class="column-header">
            <span class="column-title-text" ondblclick="app.openColumnEditor('${colName}', event)">${colName} <span class="badge">${tasks.length}</span></span>
            <button class="remove-column-btn" onclick="app.removePerson('${colName}')">‚ùå</button>
        </div>
        <div class="column-editor hidden" id="col-editor-${sanitizedId}" aria-hidden="true"></div>
      `;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'column-content';
      contentDiv.id = `col-${sanitizedId}`;
      contentDiv.onmouseenter = () => app.autoScrollManager.pauseForInteraction(); // Stability fix

      // Render Tasks
      let lastDate = null;
      tasks.forEach(task => {
        // Date Headers
        if (task.date !== lastDate) {
          const div = document.createElement('div');
          div.className = 'date-divider';
          div.textContent = task.date === today ? "TODAY" : task.date;
          contentDiv.appendChild(div);
          lastDate = task.date;
        }

        const card = document.createElement('div');
        card.className = `task-card status-${task.status} p-${task.priority}`;
        card.dataset.id = task.id;
        
        // UPGRADE: Check for subtasks in notes (syntax: "- [ ] task")
        const hasSubtasks = task.notes.includes('- [ ]') || task.notes.includes('- [x]');
        let progressBar = '';
        if (hasSubtasks) {
            const total = (task.notes.match(/- \[[ x]\]/g) || []).length;
            const done = (task.notes.match(/- \[x\]/g) || []).length;
            const pct = total > 0 ? (done / total) * 100 : 0;
            progressBar = `<div class="progress-bar-container"><div class="progress-bar-fill" style="width:${pct}%"></div></div>`;
        }

        // UPGRADE: Render Tags
        let tagHTML = '';
        if (task.tags && task.tags.length > 0) {
            tagHTML = `<div class="tag-container">${task.tags.map(t => `<span class="tag-pill">${this.escapeHtml(t)}</span>`).join('')}</div>`;
        }

        const notesPreview = task.notes.trim() ? `<div class="task-notes-preview">${this.escapeHtml(task.notes)}</div>` : '';

        card.innerHTML = `
          ${tagHTML}
          <div class="task-title" onclick="app.focusTitle('${task.id}', event)">${this.escapeHtml(task.title)}</div>
          ${notesPreview}
          ${progressBar}
          <div class="task-meta">
            <span>PRIO: ${task.priority.toUpperCase()}</span>
            <span>DUE: ${task.date}</span>
          </div>
          
          <div class="edit-area">
            <div style="margin-bottom:8px;">
              <label style="display:block; font-size:0.8rem; color:var(--text-muted); margin-bottom:3px;">Work Order</label>
              <div style="display:flex; gap:4px;">
                <input id="workorder-${task.id}" class="nexus-input" style="flex:1;" placeholder="Enter work order #" value="${this.escapeHtml(task.workOrder || '')}" onchange="app.workOrderManager.populateFromWorkOrder('${task.id}', this.value)">
                <button class="btn" style="padding:8px 12px;" onclick="app.workOrderManager.clearWorkOrder('${task.id}')" title="Clear work order">‚úï</button>
              </div>
            </div>
            
            <input id="title-edit-${task.id}" class="nexus-input" style="width:100%; margin-bottom:5px;" placeholder="Task Title" value="${this.escapeHtml(task.title)}" onkeydown="if(event.key==='Enter'){event.preventDefault(); app.saveAndCollapseTaskCard('${task.id}');}">
            <input id="tags-${task.id}" class="nexus-input" style="width:100%; margin-bottom:5px;" placeholder="Tags (comma separated)" value="${(task.tags||[]).join(', ')}">
            
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select class="nexus-input" style="flex:1;" onchange="handleUpdateTask('${task.id}', {status: this.value})">
                  <option value="none" ${task.status==='none'?'selected':''}>Pending</option>
                  <option value="inprocess" ${task.status==='inprocess'?'selected':''}>In Process</option>
                  <option value="offline" ${task.status==='offline'?'selected':''}>Blocked</option>
                  <option value="complete" ${task.status==='complete'?'selected':''}>Complete</option>
                </select>
                <select class="nexus-input" style="flex:1;" onchange="handleUpdateTask('${task.id}', {priority: this.value})">
                  <option value="low" ${task.priority==='low'?'selected':''}>Low</option>
                  <option value="medium" ${task.priority==='medium'?'selected':''}>Med</option>
                  <option value="high" ${task.priority==='high'?'selected':''}>High</option>
                </select>
            </div>
            
            <input type="date" class="nexus-input" style="width:100%; margin-bottom:5px;" value="${task.date}" onchange="handleUpdateTask('${task.id}', {date: this.value})">
            <textarea id="notes-${task.id}" class="nexus-input" style="width:100%; min-height:80px;" placeholder="Notes or Subtasks (- [ ] Item)" onkeydown="if(event.key==='Enter' && (event.ctrlKey||event.metaKey)){event.preventDefault(); app.saveAndCollapseTaskCard('${task.id}');}">${task.notes}</textarea>
            
            <button class="btn btn-primary" style="width:100%; margin-top:5px;" onclick="app.saveAndCollapseTaskCard('${task.id}')">SAVE</button>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="btn" style="flex:1;" onclick="app.archiveTask('${task.id}')">Archive</button>
                <button class="btn btn-danger" style="flex:1;" onclick="app.deleteTask('${task.id}')">Trash</button>
            </div>
          </div>
        `; 

        // Expansion Toggle - Allow free editing when expanded
        card.onclick = (e) => {
            if(['INPUT','SELECT','TEXTAREA','BUTTON'].includes(e.target.tagName)) return;
            card.classList.toggle('expanded');
        };

        contentDiv.appendChild(card);
      });


      // Quick Add
      const quickAdd = document.createElement('div');
      quickAdd.className = 'quick-add p-3 border-t border-[var(--border)]';
      quickAdd.innerHTML = `<input id="quick-add-${sanitizedId}" placeholder="+ Add Task" onkeydown="if(event.key==='Enter'){app.addTask('${colName}', this.value); this.value='';}">`;
      
      colDiv.appendChild(contentDiv);
      colDiv.appendChild(quickAdd);
      board.appendChild(colDiv);

      

new Sortable(contentDiv, {
  group: 'clarity',
  animation: 200, 
  delay: 10,
  ghostClass: 'opacity-50',
  dragClass: 'opacity-100',
  forceFallback: false,
  filter: '.expanded', // Don't allow dragging when task is expanded
  
  preventOnFilter: false, 
  
  onStart: () => app.autoScrollManager.pauseForInteraction(),
  onEnd: (evt) => this.handleDrop(evt)
});
    });

    // Grid Reordering
    new Sortable(board, {
      handle: '.column-header, .grid-blank-cell', animation: 200,
      onStart: () => app.autoScrollManager.pauseForInteraction(),
      onEnd: () => {
        this.historyManager.push();
        this.state.columns = Array.from(board.children).map(c => c.dataset.person || 'BLANK');
        this.saveState();
      }
    });

    if (focusOnColumn) {
        setTimeout(() => {
            const el = document.getElementById(`quick-add-${this._sanitizeId(focusOnColumn)}`);
            if(el) el.focus();
        }, 50);
    }
  }

  // --- THE "BULLETPROOF" LOGIC FIX ---
  handleDrop(evt) {
    const taskId = evt.item.dataset.id;
    const toCol = evt.to.closest('.column');
    
    // Safety: If dropped outside a valid column, cancel.
    if (!toCol) return;

    this.historyManager.push();
    const newPerson = toCol.dataset.person;
    const task = this.state.tasks.find(t => t.id === taskId);
    
    if (task.person !== newPerson) {
        task.person = newPerson;
        this.showToast(`Moved to ${newPerson}`);
    }

    // --- SMART DATE SNAPPING LOGIC ---
    // Always update to the most common date in the target column
    
    const siblings = Array.from(evt.to.querySelectorAll('.task-card'));
    let targetDate = task.date; // Default to self

    if (siblings.length > 0) {
      const columnTasks = siblings.map(s => this.state.tasks.find(t => t.id === s.dataset.id)).filter(t => t.id !== task.id);
      if (columnTasks.length > 0) {
        const dateCount = {};
        columnTasks.forEach(t => dateCount[t.date] = (dateCount[t.date] || 0) + 1);
        const mostCommon = Object.keys(dateCount).reduce((a, b) => dateCount[a] > dateCount[b] ? a : b);
        targetDate = mostCommon;
      }
    }

    if (task.date !== targetDate) {
        task.date = targetDate;
        this.showToast(`Rescheduled to ${targetDate}`);
    }

    // Update Sort Order
    const newIds = siblings.map(el => el.dataset.id);
    this.state.tasks.forEach(t => {
        if (t.person === newPerson) {
            const idx = newIds.indexOf(t.id);
            if (idx !== -1) t.sortOrder = idx;
        }
    });

    this.saveState();
    this.renderBoard();
  }

  setupGlobalListeners() {
    document.addEventListener('keydown', (e) => {
      if((e.ctrlKey || e.metaKey) && e.key === 'z') {
        e.preventDefault();
        this.historyManager.undo();
      }
    });
  }
}

// --- WORK ORDER MANAGER ---
// --- WORK ORDER MANAGEMENT (OPTIMIZED FOR DOCUMENT NUMBER) ---
// --- WORK ORDER MANAGEMENT (OPTIMIZED FOR DOCUMENT NUMBER) ---
class WorkOrderManager {
  constructor(app) {
    this.app = app;
    this.workOrders = [];
  }

  handleFileUpload(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        
        // raw: false preserves formatting so "Document Number" stays a string
        const rows = XLSX.utils.sheet_to_json(worksheet, { defval: "", raw: false });

        if (!rows || rows.length === 0) {
          this.app.showToast('Excel file appears to be empty.', 'error');
          return;
        }

        // Logic to find specific headers from the snippet
        const findKey = (row, possibilities) => {
          return Object.keys(row).find(k => 
            possibilities.some(p => k.toLowerCase().trim() === p.toLowerCase())
          );
        };

        const firstRow = rows[0];
        const keys = {
          wo: findKey(firstRow, ['Document Number', 'Doc #', 'Work Order']),
          name: findKey(firstRow, ['Name', 'Item']),
          desc: findKey(firstRow, ['Description']),
          qty: findKey(firstRow, ['Quantity', 'Qty']),
          left: findKey(firstRow, ['Left to Build', 'Remaining'])
        };

        if (!keys.wo) {
          this.app.showToast('Could not find "Document Number" column.', 'error');
          return;
        }

        this.workOrders = rows.map(row => ({
          workOrder: String(row[keys.wo] || '').trim().toUpperCase(),
          name: String(row[keys.name] || '').trim(),
          description: String(row[keys.desc] || '').trim(),
          qty: String(row[keys.qty] || '').trim(),
          remaining: String(row[keys.left] || '').trim()
        })).filter(wo => wo.workOrder.length > 0);

        this.app.saveState();
        this.app.showToast(`‚úì Successfully loaded ${this.workOrders.length} orders`);
        input.value = ''; 
      } catch (err) {
        console.error('Upload Error:', err);
        this.app.showToast('Error reading Excel: ' + err.message, 'error');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  populateFromWorkOrder(taskId, rawInput) {
    if (!rawInput) return;
    const search = rawInput.trim().toUpperCase();

    if (this.workOrders.length === 0) {
      this.app.showToast('Please upload the Work Order Book first.', 'error');
      return;
    }

    const wo = this.workOrders.find(w => w.workOrder === search);

    if (!wo) {
      this.app.showToast(`Order #${search} not found. It may be closed or built.`, 'error');
      return;
    }

    const task = this.app.state.tasks.find(t => t.id === taskId);
    if (task) {
      task.workOrder = wo.workOrder;
      task.title = `${wo.workOrder} - ${wo.name}`;
      
      const details = `Qty: ${wo.qty} | Left to Build: ${wo.remaining}\nDescription: ${wo.description}`;
      if (!task.notes) task.notes = details;

      if (this.app.historyManager) this.app.historyManager.push();
      this.app.saveState();
      this.app.renderBoard();
      this.app.showToast(`Linked to Document #${wo.workOrder}`);
    }
  }

  clearWorkOrder(taskId) {
    const task = this.app.state.tasks.find(t => t.id === taskId);
    if (task) {
      task.workOrder = '';
      this.app.saveState();
      this.app.renderBoard();
    }
  }

  openManageModal() {
    const modal = document.getElementById('workorder-manage-modal');
    if (!modal) return;
    const tbody = document.getElementById('workorder-table-body');
    if (tbody) {
      tbody.innerHTML = this.workOrders.slice(0, 100).map((wo, index) => `
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding:10px; font-weight:bold;">${this.app.escapeHtml(wo.workOrder)}</td>
          <td style="padding:10px;">${this.app.escapeHtml(wo.name)}</td>
          <td style="padding:10px;">${this.app.escapeHtml(wo.qty)}</td>
          <td style="padding:10px; color:var(--accent);">${this.app.escapeHtml(wo.remaining)}</td>
          <td style="padding:10px;">
            <button class="btn btn-danger" onclick="app.workOrderManager.deleteWorkOrder(${index})">DEL</button>
          </td>
        </tr>
      `).join('');
    }
    modal.classList.add('visible');
  }

  deleteWorkOrder(index) {
    if (!confirm('Delete this work order?')) return;
    this.workOrders.splice(index, 1);
    if (this.app.historyManager) this.app.historyManager.push();
    this.app.saveState();
    this.app.showToast('Work order deleted');
    this.openManageModal(); 
  }

  deleteAllWorkOrders() {
    if (!confirm('Delete ALL work orders? This cannot be undone.')) return;
    this.workOrders = [];
    if (this.app.historyManager) this.app.historyManager.push();
    this.app.saveState();
    this.app.showToast('All work orders deleted');
    this.closeManageModal();
  }

  closeManageModal() {
    const modal = document.getElementById('workorder-manage-modal');
    if (modal) modal.classList.remove('visible');
  }
}

// --- SUPPORT MODULES (UNCHANGED BUT RENAMED) ---

class AutoScrollManager {
    constructor() {
        this.isActive = false;
        this.scrollInterval = null;
        this.paused = false;
    }
    toggle() {
        this.isActive = !this.isActive;
        const btn = document.getElementById('btn-autoscroll');
        if (this.isActive) {
            btn.textContent = "üîÑ AUTO-SCROLL: ON";
            btn.classList.add('btn-active');
            this.startLoop();
        } else {
            btn.textContent = "üîÑ AUTO-SCROLL: OFF";
            btn.classList.remove('btn-active');
            this.stopLoop();
        }
    }
    startLoop() {
        if (this.scrollInterval) clearInterval(this.scrollInterval);
        this.scrollInterval = setInterval(() => {
            if (this.paused) return; 
            document.querySelectorAll('.column-content').forEach(col => {
                // Simple scroll assist
                if (col.scrollTop + col.clientHeight >= col.scrollHeight - 5) { /* bottom */ }
            });
        }, 100); 
    }
    stopLoop() { clearInterval(this.scrollInterval); }
    pauseForInteraction() {
        this.paused = true;
        setTimeout(() => this.paused = false, 2000);
    }
}

class HistoryManager {
  constructor(app) { this.app = app; this.stack = []; }
  push() {
    if(this.stack.length > 50) this.stack.shift(); // UPGRADE: Larger history buffer
    this.stack.push(JSON.stringify({c: this.app.state.columns, t: this.app.state.tasks}));
  }
  undo() {
    if(this.stack.length === 0) return this.app.showToast("Nothing to undo", "error");
    const prev = JSON.parse(this.stack.pop());
    this.app.state.columns = prev.c; 
    this.app.state.tasks = prev.t;
    this.app.saveState();
    this.app.renderBoard();
    this.app.showToast("Undo Successful");
  }
}

class IOManager {
  constructor(app) { this.app = app; }
  export() {
    const data = { 
        clarity_version: "1.0",
        columns: this.app.state.columns, 
        tasks: this.app.state.tasks,
        redTags: this.app.defectTracker.redTags,
        summaryParts: this.app.defectTracker.summaryParts,
        redTagTrash: this.app.defectTracker.redTagTrash
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clarity_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    // Close settings modal if it was open
    document.getElementById('hud-settings-modal')?.classList.remove('visible');
    this.app.showToast("Export Complete");
  }
  import(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        // UPGRADE: Support importing both Old Nexus and New Clarity files
        const cols = data.columns || data.gridCells || data.people;
        const tasks = data.tasks;
        if(cols && tasks) {
            this.app.historyManager.push();
            this.app.state.columns = cols;
            this.app.state.tasks = this.app.sanitizeTasks(tasks);
            if (data.redTags) {
                  this.app.defectTracker.redTags = this.app.defectTracker.sanitizeRedTags(data.redTags);
                  // Ensure imported NCs sync with current summary parts
                  this.app.defectTracker.refreshAllNcDetails();
                  this.app.defectTracker.saveRedTags();
            }
            if (data.summaryParts) {
              this.app.defectTracker.summaryParts = data.summaryParts;
                  this.app.defectTracker.saveSummaryParts();
                  // After loading parts, ensure NCs match the newly imported parts
                  this.app.defectTracker.refreshAllNcDetails();
            }
            if (data.redTagTrash) {
              this.app.defectTracker.redTagTrash = data.redTagTrash;
              this.app.defectTracker.saveRedTagTrash();
            }
            this.app.saveState();
            this.app.toggleMode(this.app.state.mode);
            // Close settings modal after successful import
            document.getElementById('hud-settings-modal')?.classList.remove('visible');
            this.app.showToast("Import Successful");
        } else {
            this.app.showToast("Invalid File Format", "error");
        }
      } catch(err) { console.error(err); this.app.showToast("Corrupt File", "error"); }
    };
    reader.readAsText(file);
    input.value = '';
  }
}

class DefectTracker {
  constructor(appInstance) {
    this.app = appInstance;
    this.redTags = this.loadRedTags();
    this.summaryParts = this.loadSummaryParts();
    this.redTagTrash = this.loadRedTagTrash();
    this.inspectors = this.loadInspectors();
    this.editingNc = null;
    this.searchTerm = '';
    this.filterStatus = 'ALL';
    this.pasteDataToSave = [];
    this.statusChart = null;
    this.qtyByPartChart = null;
    this.qtyByStatusChart = null;
    this.qtyByFamilyChart = null;
    this.graphVisibility = {
      status: true,
      qtyByPart: true,
      qtyByStatus: true,
      qtyByFamily: true
    };
    // Ensure NCs have family values synced at startup
    this.refreshNcFamilies();
    // Backfill any missing family values from parts list
    this._backfillFamiliesOnLoad();
    // Also perform a full details sync on load to normalize names/families
    this.refreshAllNcDetails();
  }

  // Inspectors storage
  loadInspectors() {
    const raw = localStorage.getItem('clarity_inspectors');
    if (!raw) {
      // default hard-coded list
      const defaults = ['EAC','ETB','JAB','JAB/EJL','TLG'];
      localStorage.setItem('clarity_inspectors', JSON.stringify(defaults));
      return defaults.slice();
    }
    try {
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      // normalize: unique + sorted
      const uniq = Array.from(new Set(arr.map(a => String(a).trim()).filter(Boolean)));
      uniq.sort((a,b)=>a.localeCompare(b));
      return uniq;
    } catch (e) { return []; }
  }

  saveInspectors() {
    const list = Array.from(new Set((this.inspectors || []).map(a => String(a).trim()).filter(Boolean)));
    list.sort((a,b)=>a.localeCompare(b));
    this.inspectors = list;
    localStorage.setItem('clarity_inspectors', JSON.stringify(list));
  }

  sanitizeRedTags(tags) {
    if (!Array.isArray(tags)) return [];
    return tags.map(t => ({
      nc: t.nc || this.generateNextNc(),
      status: t.status || 'IN PROCESS',
      partNumber: t.partNumber || '',
      serial: t.serial || '',
      partName: t.partName || '',
      family: t.family || '',
      dateLogged: t.dateLogged || this.app.getLocalDate(),
      qty: parseInt(t.qty) || 1,
      inspector: t.inspector || '',
      description: t.description || '',
      disposition: t.disposition || '',
      notes: t.notes || ''
    }));
  }

  loadRedTags() {
    const data = localStorage.getItem('clarity_red_tags');
    return this.sanitizeRedTags(data ? JSON.parse(data) : this.initialRedTags);
  }

  saveRedTags() {
    try {
      localStorage.setItem('clarity_red_tags', JSON.stringify(this.redTags));
      // Only push to cloud after the app has completed initial realtime load
      if (this.app && this.app.initialized && typeof this.app.saveState === 'function') {
        this.app.saveState();
      }
    } catch (e) {
      console.error('saveRedTags error', e);
    }
  }

  loadSummaryParts() {
    const data = localStorage.getItem('clarity_summary_parts');
    let parts = data ? JSON.parse(data) : [];
    if (!parts || parts.length === 0) {
      // Fallback to built-in initial list so matching works on first load
      parts = Array.isArray(this.initialSummaryParts) ? this.initialSummaryParts.slice() : [];
      console.log(`[loadSummaryParts] No localStorage parts found; using initialSummaryParts (${parts.length})`);
    } else {
      console.log(`[loadSummaryParts] Loaded ${parts.length} parts from localStorage.`);
    }
    return parts;
  }

  saveSummaryParts() {
    try {
      localStorage.setItem('clarity_summary_parts', JSON.stringify(this.summaryParts));
      if (this.app && this.app.initialized && typeof this.app.saveState === 'function') {
        this.app.saveState();
      }
    } catch (e) {
      console.error('saveSummaryParts error', e);
    }
  }

  loadRedTagTrash() {
    const data = localStorage.getItem('clarity_red_tag_trash');
    return data ? JSON.parse(data) : [];
  }

  saveRedTagTrash() {
    try {
      localStorage.setItem('clarity_red_tag_trash', JSON.stringify(this.redTagTrash));
      if (this.app && this.app.initialized && typeof this.app.saveState === 'function') {
        this.app.saveState();
      }
    } catch (e) {
      console.error('saveRedTagTrash error', e);
    }
  }

  getStatusClass(status) {
    switch (status) {
      case 'SCRAP': return 'red-tag-status-scrap';
      case 'IN PROCESS': return 'red-tag-status-process';
      case 'REPAIRED/CLOSED': return 'red-tag-status-repaired';
      default: return '';
    }
  }

  generateNextNc() {
    const mainNcs = this.redTags.filter(t => !t.nc.includes('.')).map(t => parseInt(t.nc.replace('NC-', '')) || 0);
    const max = mainNcs.length > 0 ? Math.max(...mainNcs) : 0;
    return `NC-${String(max + 1).padStart(5, '0')}`;
  }

  handleCheckboxChange(nc, field, value) {
    const item = this.redTags.find(t => t.nc === nc);
    if (item) {
      item[field] = value;
      this.saveRedTags();
      this.render();
    }
  }

  createRow(item, index) {
    const rowClass = index % 2 === 0 ? 'bg-[var(--bg-card)]' : 'bg-[var(--bg-panel)]';
    const statusClass = this.getStatusClass(item.status);
    
    const isInvalid = !item.nc || !item.status;
    const validationClass = isInvalid ? 'red-tag-data-warning' : '';

    const statusCell = `<span style="padding:2px 8px; font-size:0.75rem; font-weight:600; border-radius:4px; ${statusClass ? 'background:var(--bg-panel); color:var(--accent);' : ''}">${item.status || 'N/A'}</span>`;

    return `
        <tr class="defect-row ${rowClass} ${validationClass}">
            <td style="padding:15px; border-right:1px solid var(--border);">${item.nc}</td>
            <td style="padding:15px; text-align:center; border-right:1px solid var(--border);">${statusCell}</td>
            <td style="padding:15px; border-right:1px solid var(--border);">${item.partNumber || ''}</td>
            <td style="padding:15px; border-right:1px solid var(--border);">${item.serial || ''}</td>
            <td style="padding:15px; border-right:1px solid var(--border);">${item.partName || ''}</td>
        <td style="padding:15px; border-right:1px solid var(--border);">${item.family || ''}</td>
            <td style="padding:15px; border-right:1px solid var(--border);">${item.dateLogged || ''}</td>
            <td style="padding:15px; text-align:center; border-right:1px solid var(--border);">${item.qty || ''}</td>
            <td style="padding:15px; border-right:1px solid var(--border);">${item.inspector || ''}</td>
            <td style="padding:15px; white-space: pre-wrap; word-wrap: break-word; max-width:300px; border-right:1px solid var(--border);">${item.description || ''}</td>
            <td style="padding:15px; white-space: pre-wrap; word-wrap: break-word; max-width:300px; border-right:1px solid var(--border);">${item.disposition || ''}</td>
            <td style="padding:15px; white-space: pre-wrap; word-wrap: break-word; max-width:300px; border-right:1px solid var(--border);">${item.notes || ''}</td>
            <td style="padding:15px; text-align:center;">
                <button class="btn" style="margin:0 5px;" onclick="app.defectTracker.openEditModal('${item.nc}')">Edit</button>
                <button class="btn btn-danger" style="margin:0 5px;" onclick="app.defectTracker.deleteNc('${item.nc}')">DEL</button>
            </td>
        </tr>
    `;
  }

  render() {
    const tableBody = document.getElementById('red-tag-table-body');
    const noResultsDiv = document.getElementById('red-tag-no-results');
    const recordCountSpan = document.getElementById('red-tag-record-count');

    let filteredData = this.redTags.filter(item => {
        const statusMatch = this.filterStatus === 'ALL' || item.status === this.filterStatus;
        const searchMatch = Object.values(item).some(value => 
            String(value).toLowerCase().includes(this.searchTerm)
        );
        return statusMatch && searchMatch;
    });

    tableBody.innerHTML = filteredData.map((item, index) => this.createRow(item, index)).join('');

    if (filteredData.length === 0 && this.redTags.length > 0) {
        noResultsDiv.classList.remove('hidden');
    } else if (this.redTags.length === 0) {
        noResultsDiv.textContent = "No Red Tag records found. Use '+ NEW NC' or 'Paste Data' to begin.";
        noResultsDiv.classList.remove('hidden');
    } else {
        noResultsDiv.classList.add('hidden');
    }

    recordCountSpan.textContent = `Displaying ${filteredData.length} of ${this.redTags.length} records.`;
  }

  handleSearch(val) {
    this.searchTerm = val.toLowerCase();
    this.render();
  }

  handleFilterChange() {
    this.filterStatus = document.getElementById('red-tag-status-filter').value;
    this.render();
  }

  toggleTableVisibility() {
    const table = document.getElementById('red-tag-table');
    const btn = document.getElementById('toggle-table-btn');
    const isHidden = table.style.display === 'none';
    
    if (isHidden) {
      table.style.display = '';
      btn.textContent = 'üóï Hide';
    } else {
      table.style.display = 'none';
      btn.textContent = 'üóñ Show';
    }
  }

  prepareAddNC() {
    const form = document.getElementById('new-nc-form');
    form.reset();
    form.querySelector('[name="nc"]').value = this.generateNextNc();
    form.querySelector('[name="dateLogged"]').value = this.app.getLocalDate();
    form.onsubmit = (event) => this.handleSubmitNewNC(event);
    this.populateSummaryDropdowns('new-partNumber', 'new-partName');
    document.getElementById('add-nc-modal').classList.add('visible');
  }

  handleSubmitNewNC(event) {
    event.preventDefault();
    const form = event.target;
    const data = Object.fromEntries(new FormData(form).entries());

    data.qty = parseInt(data.qty) || 1;
    
    if (!data.nc || !data.status) {
        this.app.showToast("Error: NC# and Status are mandatory fields.", 'error');
        return;
    }

    Object.keys(data).forEach(key => {
        if (typeof data[key] === 'string') data[key] = data[key].trim();
    });

    if (this.redTags.some(item => item.nc === data.nc)) {
        this.app.showToast(`NC ${data.nc} already exists. Use a unique NC#.`, 'error');
        return;
    }

    try {
        this.redTags.push(data);
        this.saveRedTags();
        this.app.showToast(`NC ${data.nc} saved successfully.`, 'success');
        this.render();
        document.getElementById('add-nc-modal').classList.remove('visible');
    } catch (error) {
        console.error("Error adding new NC:", error);
        this.app.showToast(`Failed to save NC ${data.nc}.`, 'error');
    }
  }

  openEditModal(nc) {
    const item = this.redTags.find(t => t.nc === nc);
    if (!item) return;

    const form = document.getElementById('edit-nc-form');
    // Populate dropdowns first so select options exist, then populate form values
    this.populateSummaryDropdowns('edit-partNumber', 'edit-partName');
    this.populateForm(form, item);
    form.onsubmit = (event) => this.handleEditNC(event, nc);
    // Ensure family input shows current family
    const familyInput = form.querySelector('[name="family"]');
    if (familyInput) familyInput.value = item.family || '';
    document.getElementById('edit-nc-modal').classList.add('visible');
  }

  handleEditNC(event, originalNc) {
    event.preventDefault();
    const form = event.target;
    const data = Object.fromEntries(new FormData(form).entries());

    data.qty = parseInt(data.qty) || 1;
    
    if (!data.nc || !data.status) {
        this.app.showToast("Error: NC# and Status are mandatory fields.", 'error');
        return;
    }

    Object.keys(data).forEach(key => {
        if (typeof data[key] === 'string') data[key] = data[key].trim();
    });

    const index = this.redTags.findIndex(item => item.nc === originalNc);
    if (index !== -1) {
        if (data.nc !== originalNc && this.redTags.some(item => item.nc === data.nc)) {
            this.app.showToast(`NC ${data.nc} already exists.`, 'error');
            return;
        }
        this.redTags[index] = data;
        this.saveRedTags();
        this.app.showToast(`NC ${data.nc} updated successfully.`, 'success');
        this.render();
        document.getElementById('edit-nc-modal').classList.remove('visible');
    }
  }

  deleteNc(nc) {
    if (!confirm(`Delete NC ${nc}? This will move it to trash.`)) return;
    const index = this.redTags.findIndex(item => item.nc === nc);
    if (index !== -1) {
        const deleted = this.redTags.splice(index, 1)[0];
        this.redTagTrash.push(deleted);
        this.saveRedTags();
        this.saveRedTagTrash();
        this.render();
        this.app.showToast(`NC ${nc} deleted. Use Undo to restore.`, 'success');
    }
  }

  undoDelete() {
    if (this.redTagTrash.length === 0) {
        this.app.showToast('No items to undo.', 'warning');
        return;
    }
    const lastDeleted = this.redTagTrash.pop();
    if (this.redTags.some(item => item.nc === lastDeleted.nc)) {
        this.app.showToast(`Cannot restore: NC ${lastDeleted.nc} already exists.`, 'error');
        return;
    }
    this.redTags.push(lastDeleted);
    this.saveRedTags();
    this.saveRedTagTrash();
    this.render();
    this.app.showToast(`Restored NC ${lastDeleted.nc}.`, 'success');
  }

  // Permanently move all NCs to trash (redTagTrash) but allow restore from trash modal
  deleteAllNcs() {
    if (!confirm('Delete ALL NCs? This will move all NCs to the Red Tag Trash (you can restore individually).')) return;
    if (this.redTags.length === 0) { this.app.showToast('No NCs to delete.', 'warning'); return; }
    // Move all to trash
    const moved = this.redTags.splice(0, this.redTags.length);
    this.redTagTrash.push(...moved);
    this.saveRedTags();
    this.saveRedTagTrash();
    this.render();
    this.app.showToast(`Moved ${moved.length} NC(s) to Red Tag Trash.`, 'success');
    // Open Trash modal so user can review/restore if needed
    this.openTrashModal();
  }

  openTrashModal() {
    const container = document.getElementById('red-tag-deleted-container');
    container.innerHTML = '';
    this.redTagTrash.forEach(tag => {
        const div = document.createElement('div');
        div.className = 'trash-card';
        div.innerHTML = `
          <div style="flex-grow: 1;">
            <div style="font-weight: 700; color: var(--text-main);">${tag.nc} - ${this.app.escapeHtml(tag.description.substring(0,50)) || 'No description'}</div>
            <div class="trash-meta">${tag.status} | ${tag.dateLogged}</div>
          </div>
          <button class="btn btn-primary" onclick="app.defectTracker.restoreFromTrash('${tag.nc}')">RESTORE</button>
          <button class="btn" onclick="app.defectTracker.permanentDeleteFromTrash('${tag.nc}')">DEL</button>
        `;
        container.appendChild(div);
    });
    if (this.redTagTrash.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted); text-align:center;">Empty.</p>';
    }
    document.getElementById('red-tag-trash-modal').classList.add('visible');
  }

  closeTrashModal() {
    document.getElementById('red-tag-trash-modal').classList.remove('visible');
  }

  restoreFromTrash(nc) {
    const index = this.redTagTrash.findIndex(t => t.nc === nc);
    if (index !== -1) {
        const restored = this.redTagTrash.splice(index, 1)[0];
        if (this.redTags.some(t => t.nc === restored.nc)) {
            this.app.showToast(`Cannot restore: NC ${restored.nc} already exists.`, 'error');
            return;
        }
        this.redTags.push(restored);
        this.saveRedTags();
        this.saveRedTagTrash();
        this.render();
        this.openTrashModal();
        this.app.showToast(`Restored NC ${restored.nc}.`, 'success');
    }
  }

  permanentDeleteFromTrash(nc) {
    if (!confirm(`Permanently delete NC ${nc}?`)) return;
    const index = this.redTagTrash.findIndex(t => t.nc === nc);
    if (index !== -1) {
        this.redTagTrash.splice(index, 1);
        this.saveRedTagTrash();
        this.openTrashModal();
        this.app.showToast(`Permanently deleted NC ${nc}.`, 'success');
    }
  }

  emptyTrash() {
    if (this.redTagTrash.length === 0) {
        this.app.showToast('Trash is empty.', 'warning');
        return;
    }
    if (!confirm('Permanently delete all items in trash?')) return;
    this.redTagTrash = [];
    this.saveRedTagTrash();
    this.openTrashModal();
    this.app.showToast('Trash emptied.', 'success');
  }

  openPasteModal() {
    document.getElementById('paste-modal').classList.add('visible');
  }

  closePasteModal() {
    document.getElementById('paste-modal').classList.remove('visible');
    document.getElementById('paste-data').classList.remove('hidden');
    document.getElementById('paste-preview-section').classList.add('hidden');
    document.getElementById('paste-modal-title').textContent = 'Paste Spreadsheet Data (TSV)';
    document.getElementById('paste-area').value = '';
    document.getElementById('paste-save-btn').disabled = false;
  }

  handlePasteData() {
    const clipboardData = document.getElementById('paste-area').value;
    if (!clipboardData || !clipboardData.trim()) {
      this.app.showToast('Paste area is empty.', 'warning');
      return;
    }

    console.log('[handlePasteData] Starting paste processing...');
    document.getElementById('paste-modal-title').textContent = 'Processing Data...';
    document.getElementById('paste-save-btn').disabled = true;

    const lines = clipboardData.trim().split('\n').map(l => l.replace(/\r/g, '')).filter(l => l.trim());
    if (lines.length === 0) return;

    const splitRow = (r) => r.split('\t').map(c => c.trim());
    const headerCandidates = splitRow(lines[0]);

    // Normalizer for header comparison
    const norm = s => (s || '').toString().toLowerCase().replace(/[^a-z0-9]/g, '');

    // Decide if first row is header: if many header tokens match columnMap or contain letters
    const headerScore = headerCandidates.reduce((acc, h) => {
      if (!h) return acc;
      const hNorm = norm(h);
      const matchKey = Object.keys(this.columnMap).some(k => {
        const kNorm = norm(k);
        return kNorm === hNorm || kNorm.includes(hNorm) || hNorm.includes(kNorm);
      });
      return acc + (matchKey ? 1 : 0);
    }, 0);

    const likelyHeader = headerScore >= Math.max(1, Math.floor(headerCandidates.length / 3)) || headerCandidates.some(h => /[a-zA-Z]/.test(h));

    // If header is likely, use it; otherwise try to detect columns heuristically from content
    let dataLines = likelyHeader ? lines.slice(1) : lines.slice(0);
    const indexMap = {};

    // If header present, map by header names (prefer specific headers and avoid duplicate canonical keys)
    if (likelyHeader) {
      const usedCanonical = new Set();
      headerCandidates.forEach((h, i) => {
        const hNorm = norm(h);
        let mapped = null;

        // Very specific rules first to avoid collisions
        if (hNorm.includes('nc') && (hNorm.includes('closed') || hNorm.includes('close') || hNorm.includes('closeddate'))) {
          mapped = 'ncClosed';
        } else if (hNorm.includes('initial')) {
          mapped = 'inspector';
        } else if (hNorm.includes('repaired') && !hNorm.includes('part')) {
          mapped = 'repaired';
        } else if (hNorm === 'scrap' || hNorm.includes('scrap')) {
          mapped = 'scrap';
        }

        // Exact key matches next (prefer full key equality)
        if (!mapped) {
          for (const key of Object.keys(this.columnMap)) {
            const kNorm = norm(key);
            if (kNorm === hNorm) {
              mapped = this.columnMap[key];
              break;
            }
          }
        }

        // Broad matches (contains/startsWith)
        if (!mapped) {
          for (const key of Object.keys(this.columnMap)) {
            const kNorm = norm(key);
            if (kNorm.includes(hNorm) || hNorm.includes(kNorm) || kNorm.startsWith(hNorm) || hNorm.startsWith(kNorm)) {
              mapped = this.columnMap[key];
              break;
            }
          }
        }

        // Heuristics for common tokens
        if (!mapped) {
          if (hNorm.includes('part') && hNorm.includes('num')) mapped = 'partNumber';
          else if (hNorm.includes('part') && hNorm.includes('name')) mapped = 'partName';
          else if (hNorm.includes('date')) mapped = 'dateLogged';
          else if (hNorm === 'nc' || /^nc[#\-]*\d*/.test(h.trim().toLowerCase())) mapped = 'nc';
          else if (hNorm.includes('status')) mapped = 'status';
          else if (hNorm.includes('serial')) mapped = 'serial';
          else if (hNorm.includes('qty')) mapped = 'qty';
          else mapped = h.trim() || null;
        }

        // Avoid mapping the same canonical key twice (prefer first occurrence)
        if (mapped && usedCanonical.has(mapped)) {
          // leave unmapped to avoid collisions
          mapped = null;
        } else if (mapped) usedCanonical.add(mapped);

        indexMap[i] = mapped;
      });
    } else {
      // Heuristic: look at sample cells per column to infer type
      const sampleRows = lines.slice(0, Math.min(6, lines.length)).map(splitRow);
      const colCount = Math.max(...sampleRows.map(r => r.length));
      for (let i = 0; i < colCount; i++) {
        const samples = sampleRows.map(r => (r[i] || '').trim()).filter(Boolean);
        const sampleStr = samples.join(' ');
        // If many values match NC pattern, map to nc
        const ncMatches = samples.filter(s => /^NC[-_.\d]/i.test(s) || /^nc[-_.\d]/i.test(s)).length;
        if (ncMatches >= Math.max(1, Math.floor(samples.length / 2))) { indexMap[i] = 'nc'; continue; }
        const statusMatches = samples.filter(s => this.statusOptions.includes((s || '').toUpperCase())).length;
        if (statusMatches >= Math.max(1, Math.floor(samples.length / 2))) { indexMap[i] = 'status'; continue; }
        const qtyMatches = samples.filter(s => /^\d+$/.test(s)).length;
        if (qtyMatches >= Math.max(1, Math.floor(samples.length / 2))) { indexMap[i] = 'qty'; continue; }
        // fallback: look for part numbers by comparing to summaryParts
        const partMatch = samples.find(s => {
          const key = this._normalizeKey(s);
          return this.summaryParts.some(p => this._normalizeKey(p.partNumber) === key || this._normalizeKey(p.partName) === key);
        });
        if (partMatch) { indexMap[i] = 'partNumber'; continue; }
        // lastly, if cell contains many letters assume description
        if (/[a-zA-Z]/.test(sampleStr)) { indexMap[i] = 'description'; continue; }
        indexMap[i] = null;
      }
    }

    // Ensure we didn't accidentally map the same canonical key twice (safety)
    const seen = new Set();
    Object.keys(indexMap).forEach(k => {
      const v = indexMap[k];
      if (!v) return;
      if (seen.has(v)) indexMap[k] = null;
      else seen.add(v);
    });

    const processedData = [];
    const diagnostics = [];
    let invalidCount = 0;

    for (let lineIdx = 0; lineIdx < dataLines.length; lineIdx++) {
      const line = dataLines[lineIdx];
      const cells = splitRow(line);
      const row = {};
      for (let i = 0; i < cells.length; i++) {
        const key = indexMap[i];
        if (!key) continue;
        let val = cells[i].trim();
        if (['ncClosed', 'repaired', 'scrap'].includes(key)) row[key] = ['true','1','yes','y'].includes(val.toLowerCase());
        else if (key === 'qty') row[key] = parseInt(val) || 0;
        else if (key === 'status') row[key] = (val || '').toUpperCase();
        else row[key] = val;
      }

      const enriched = this._matchAndApplySummary(row);
      enriched.status = this._normalizeStatus(enriched.status);
      
      // Ensure family is populated: _matchAndApplySummary should have set it, but as fallback lookup again
      if (!enriched.family || enriched.family.toString().trim() === '') {
        const lookedUpFamily = this._getFamilyFromSummaryParts(enriched.partNumber, enriched.partName);
        if (lookedUpFamily && lookedUpFamily.trim() !== '') {
          enriched.family = lookedUpFamily;
        }
      }
      console.log(`[handlePasteData] Line ${lineIdx}: NC="${enriched.nc}" PN="${enriched.partNumber}" Family="${enriched.family}"`);

      let reason = null;
      if (!enriched.nc) reason = 'missing_nc';
      else if (!enriched.status) reason = 'missing_or_unrecognized_status';

      if (reason) invalidCount++;

      if (enriched.nc) {
        enriched.isValid = !reason;
        processedData.push(enriched);
      }

      diagnostics.push({
        lineIndex: lineIdx + (likelyHeader ? 2 : 1), // human-friendly (account for header)
        raw: line,
        parsed: row,
        enriched: enriched,
        reason: reason
      });
    }

    document.getElementById('paste-modal-title').textContent = 'Data Preview (Review & Save)';
    document.getElementById('paste-save-btn').disabled = false;

    let previewHtml = `<p style="color:var(--text-muted); margin-bottom:16px; font-size:0.9rem;">Found ${processedData.length} records to process (${invalidCount} invalid).</p>`;
    // Show indexMap diagnostics
    previewHtml += `<div style="margin-bottom:8px; color:var(--text-muted); font-size:0.85rem;"><strong>Inferred column mapping:</strong> <pre style="white-space:pre-wrap; background:var(--bg-card); padding:8px; border:1px solid var(--border);">${JSON.stringify(indexMap, null, 2)}</pre></div>`;
    previewHtml += `<div style="overflow-x:auto; border:1px solid var(--border); border-radius:4px;"><table style="min-width:100%; border-collapse:collapse;"><thead><tr style="background:var(--bg-panel); text-align:left; color:var(--accent); font-weight:800; font-size:0.8rem;">
      <th style="padding:10px;">NC#</th><th style="padding:10px;">Status</th><th style="padding:10px;">Part</th><th style="padding:10px;">Part Name</th><th style="padding:10px;">Family</th><th style="padding:10px; text-align:center;">Qty</th><th style="padding:10px; text-align:center;">Closed</th></tr></thead><tbody style="divide-y divide-[var(--border)];">`;

    processedData.forEach(item => {
      const rowClass = item.isValid ? '' : 'background:rgba(239,68,68,0.15)';
      const ncStatus = item.isValid ? 'color:var(--accent)' : 'color:#ef4444';
        previewHtml += `<tr style="${rowClass}">
          <td style="padding:10px; font-weight:600; ${ncStatus}">${item.nc}</td>
          <td style="padding:10px;">${item.status}</td>
          <td style="padding:10px; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${item.partNumber || ''}">${item.partNumber || ''}</td>
          <td style="padding:10px; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.partName || ''}</td>
          <td style="padding:10px;">${item.family || ''}</td>
          <td style="padding:10px; text-align:center;">${item.qty || ''}</td>
          <td style="padding:10px; text-align:center;">${item.ncClosed ? '‚úì' : '‚úó'}</td>
        </tr>`;
    });

    previewHtml += `</tbody></table></div>`;
    // Add diagnostics section for any invalid rows
    if (diagnostics.length > 0) {
      let diagHtml = '<div style="margin-top:12px; color:var(--text-muted);"><strong>Row diagnostics (showing parsed fields and invalid reason):</strong><div style="background:var(--bg-card); padding:8px; border:1px solid var(--border); margin-top:8px; max-height:200px; overflow:auto;">';
      diagnostics.forEach(d => {
        const reason = d.reason ? `<strong style="color:#ef4444;">${d.reason}</strong>` : `<span style="color:var(--accent)">valid</span>`;
        diagHtml += `<div style="padding:6px; border-bottom:1px dashed var(--border); font-size:0.85rem;">Line ${d.lineIndex}: ${reason}<br/><pre style="white-space:pre-wrap; margin:6px 0;">Parsed: ${JSON.stringify(d.parsed)}</pre></div>`;
      });
      diagHtml += '</div></div>';
      previewHtml += diagHtml;
    }
    document.getElementById('paste-preview').innerHTML = previewHtml;
    document.getElementById('paste-data').classList.add('hidden');
    document.getElementById('paste-preview-section').classList.remove('hidden');

    this.pasteDataToSave = processedData.filter(i => i.isValid).map(i => { delete i.isValid; return i; });
  }

  savePastedData() {
    const dataToSave = this.pasteDataToSave;
    if (!dataToSave || dataToSave.length === 0) {
        this.app.showToast("No valid data to save.", 'warning');
        return;
    }

    console.log(`[savePastedData] Saving ${dataToSave.length} items...`);
    let addedCount = 0;
    let updatedCount = 0;

    for (const item of dataToSave) {
        const cleanItem = { ...item };
        delete cleanItem.isValid;

        const index = this.redTags.findIndex(existing => existing.nc === cleanItem.nc);
        if (index !== -1) {
            // IMPORTANT: Preserve family when merging with existing record
            const existingFamily = this.redTags[index].family || '';
            const incomingFamily = cleanItem.family || '';
            const finalFamily = incomingFamily.trim() !== '' ? incomingFamily : existingFamily;
            
            console.log(`[savePastedData] Updating NC ${cleanItem.nc}: existing family="${existingFamily}" incoming="${incomingFamily}" final="${finalFamily}"`);
            
            this.redTags[index] = { ...this.redTags[index], ...cleanItem, family: finalFamily };
            updatedCount++;
        } else {
            console.log(`[savePastedData] Adding new NC ${cleanItem.nc}: family="${cleanItem.family}"`);
            this.redTags.push(cleanItem);
            addedCount++;
        }
    }

    // Add any inspectors discovered during paste into inspectors list
    try {
      const pastedInspectors = Array.from(new Set(dataToSave.map(d => (d.inspector || '').trim()).filter(Boolean)));
      if (pastedInspectors.length > 0) {
        this.inspectors = Array.from(new Set([...(this.inspectors||[]), ...pastedInspectors].map(s=>String(s).trim()).filter(Boolean)));
        this.inspectors.sort((a,b)=>a.localeCompare(b));
        this.saveInspectors();
        this.populateInspectorDropdowns();
        // If inspectors modal open, re-render table
        const modal = document.getElementById('manage-inspectors-modal');
        if (modal && modal.classList.contains('visible')) this.renderInspectorsTable();
      }
    } catch (e) { console.error('Error merging pasted inspectors', e); }

    try {
      // Save pasted data (with family preserved/enriched from paste flow)
      this.saveRedTags();
      console.log(`[savePastedData] Saved. Calling render() to display updated data.`);
        this.app.showToast(`Batch Save Complete! Added: ${addedCount}, Updated: ${updatedCount}.`, 'success');
        this.render();
        this.closePasteModal();
    } catch (error) {
        console.error("Error saving batch data:", error);
        this.app.showToast(`Batch save failed.`, 'error');
    }
  }

  populateSummaryDropdowns(numberId, nameId) {
    const partNumberSelect = document.getElementById(numberId);
    const partNameSelect = document.getElementById(nameId);
    partNumberSelect.innerHTML = '<option value="">Select Part...</option>';
    partNameSelect.innerHTML = '<option value="">Select Part Desc....</option>';

    const partNumbers = {};
    const partNames = {};

    this.summaryParts.forEach(part => {
        if (part.partNumber) partNumbers[part.partNumber] = { name: part.partName, family: part.family || '' };
        if (part.partName) partNames[part.partName] = { number: part.partNumber, family: part.family || '' };
    });

    Object.keys(partNumbers).sort().forEach(pn => {
        const option = document.createElement('option');
        option.value = pn;
        option.textContent = pn;
        partNumberSelect.appendChild(option);
    });

    Object.keys(partNames).sort().forEach(pname => {
        const option = document.createElement('option');
        option.value = pname;
        option.textContent = pname;
        partNameSelect.appendChild(option);
    });

    // Update paired select and set hidden family input when selection changes
    const familyInputId = numberId === 'new-partNumber' ? 'new-family' : 'edit-family';
    const familyInput = document.getElementById(familyInputId);

    partNumberSelect.onchange = () => {
        const pn = partNumberSelect.value;
        partNameSelect.value = pn ? (partNumbers[pn] ? partNumbers[pn].name : '') : '';
        if (familyInput) familyInput.value = pn ? (partNumbers[pn] ? partNumbers[pn].family : '') : '';
    };
    partNameSelect.onchange = () => {
        const pname = partNameSelect.value;
        partNumberSelect.value = pname ? (partNames[pname] ? partNames[pname].number : '') : '';
        if (familyInput) familyInput.value = pname ? (partNames[pname] ? partNames[pname].family : '') : '';
    };
    // Ensure inspector selects are populated whenever we prepare part dropdowns
    this.populateInspectorDropdowns();
  }

  // Populate all inspector select elements with current inspectors
  populateInspectorDropdowns() {
    const selects = Array.from(document.querySelectorAll('select[name="inspector"]'));
    const list = (this.inspectors || []).slice().map(s=>String(s).trim()).filter(Boolean);
    list.sort((a,b)=>a.localeCompare(b));
    selects.forEach(sel => {
      const current = sel.value;
      sel.innerHTML = '<option value="">Select Inspector</option>';
      list.forEach(ins => {
        const opt = document.createElement('option');
        opt.value = ins;
        opt.textContent = ins;
        sel.appendChild(opt);
      });
      if (current) sel.value = current;
    });
  }

  // Manage Inspectors modal handlers
  openManageInspectorsModal() {
    this.renderInspectorsTable();
    document.getElementById('manage-inspectors-modal').classList.add('visible');
  }
  closeManageInspectorsModal() { document.getElementById('manage-inspectors-modal').classList.remove('visible'); }

  renderInspectorsTable() {
    const body = document.getElementById('inspectors-table-body');
    if (!body) return;
    body.innerHTML = '';
    const list = (this.inspectors || []).slice().map(s=>String(s).trim()).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    (list).forEach(ins => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:10px;">${this.app.escapeHtml(ins)}</td>
        <td style="padding:10px; display:flex; gap:8px;">
          <button class="btn" onclick="app.defectTracker.openEditInspectorModal('${this.app.escapeHtml(ins)}')">Edit</button>
          <button class="btn" onclick="app.defectTracker.deleteInspector('${this.app.escapeHtml(ins)}')">Delete</button>
        </td>
      `;
      body.appendChild(row);
    });
  }

  // Edit inspector handlers
  openEditInspectorModal(initials) {
    const modal = document.getElementById('edit-inspector-modal');
    const form = document.getElementById('edit-inspector-form');
    if (!modal || !form) return;
    form.elements['original'].value = initials || '';
    form.elements['initials'].value = initials || '';
    modal.classList.add('visible');
  }

  closeEditInspectorModal() { const m = document.getElementById('edit-inspector-modal'); if (m) m.classList.remove('visible'); }

  handleEditInspector(event) {
    event.preventDefault();
    const data = Object.fromEntries(new FormData(event.target).entries());
    const orig = (data.original || '').trim();
    const updated = (data.initials || '').trim();
    if (!updated) { this.app.showToast('Please enter initials', 'error'); return; }
    if (!this.inspectors) this.inspectors = [];
    // Prevent duplicate unless it's the same original
    if (this.inspectors.includes(updated) && updated !== orig) { this.app.showToast('Inspector already exists', 'warning'); return; }
    this.inspectors = this.inspectors.map(i => (i === orig ? updated : i));
    this.saveInspectors();
    this.populateInspectorDropdowns();
    this.renderInspectorsTable();
    this.closeEditInspectorModal();
    this.app.showToast('Inspector updated', 'success');
  }

  openAddInspectorModal() { document.getElementById('add-inspector-modal').classList.add('visible'); }
  closeAddInspectorModal() { document.getElementById('add-inspector-modal').classList.remove('visible'); }

  handleAddInspector(event) {
    event.preventDefault();
    const form = event.target;
    const data = Object.fromEntries(new FormData(form).entries());
    const initials = (data.initials || '').trim();
    if (!initials) { this.app.showToast('Please enter initials', 'error'); return; }
    if (!this.inspectors) this.inspectors = [];
    if (this.inspectors.includes(initials)) { this.app.showToast('Inspector already exists', 'warning'); return; }
    this.inspectors.push(initials);
    this.saveInspectors();
    this.populateInspectorDropdowns();
    this.renderInspectorsTable();
    this.closeAddInspectorModal();
    this.app.showToast('Inspector added', 'success');
    form.reset();
  }

  deleteInspector(initials) {
    if (!confirm(`Delete inspector ${initials}?`)) return;
    this.inspectors = (this.inspectors || []).filter(i => i !== initials);
    this.saveInspectors();
    this.populateInspectorDropdowns();
    this.renderInspectorsTable();
    this.app.showToast('Inspector removed', 'success');
  }

  // Ensure each NC's family field is in sync with the summary parts list
  refreshNcFamilies() {
    // Use same normalization as _normalizeKey for consistency
    const partsByNumber = new Map();
    const partsByName = new Map();
    this.summaryParts.forEach(p => {
      const kNum = this._normalizeKey(p.partNumber);
      const kName = this._normalizeKey(p.partName);
      const fam = (p.family || '').toString().trim();
      if (kNum) partsByNumber.set(kNum, { partNumber: p.partNumber, partName: p.partName, family: fam });
      if (kName) partsByName.set(kName, { partNumber: p.partNumber, partName: p.partName, family: fam });
    });
    let changed = false;
    this.redTags.forEach(tag => {
      const pnKey = this._normalizeKey(tag.partNumber);
      const nameKey = this._normalizeKey(tag.partName);
      let fam = '';
      let matchedPart = null;
      if (pnKey && partsByNumber.has(pnKey)) {
        matchedPart = partsByNumber.get(pnKey);
        fam = matchedPart.family || '';
      } else if (nameKey && partsByName.has(nameKey)) {
        matchedPart = partsByName.get(nameKey);
        fam = matchedPart.family || '';
      }

      if ((tag.family || '') !== (fam || '')) {
        tag.family = fam || '';
        changed = true;
      }
    });
    if (changed) {
      this.saveRedTags();
      this.render();
    }
  }

  // Helper to create normalized key for fuzzy matching
  _normalizeKey(s) {
    return (s || '').toString().trim().toLowerCase()
      .replace(/\(.*?\)/g, '')              // remove parenthetical notes
      .replace(/[-_‚Äì‚Äî]+/g, ' ')               // normalize dashes/underscores to spaces
      .replace(/[^a-z0-9 ]/gi, '')            // remove any remaining non-alphanumerics (keep spaces)
      .replace(/\s+/g, ' ')                  // collapse multiple spaces
      .trim();
  }

  // Try to match a partial row against summaryParts and populate partName/family
  _matchAndApplySummary(row) {
    const out = { ...(row || {}) };
    // Normalize keys
    const pn = (out.partNumber || '').toString().trim();
    const pname = (out.partName || '').toString().trim();

    const keyPn = this._normalizeKey(pn);
    const keyName = this._normalizeKey(pname);

    // Debug: log what we're trying to match
    console.log(`[_matchAndApplySummary] Row partNumber="${pn}" (normalized="${keyPn}"), partName="${pname}" (normalized="${keyName}")`);
    console.log(`[_matchAndApplySummary] summaryParts count:`, this.summaryParts.length);

    // Build quick maps
    const byNum = new Map();
    const byName = new Map();
    this.summaryParts.forEach(p => {
      const kn = this._normalizeKey(p.partNumber);
      const knm = this._normalizeKey(p.partName);
      const entry = { partNumber: p.partNumber, partName: p.partName, family: (p.family || '').toString().trim() };
      if (kn) byNum.set(kn, entry);
      if (knm) byName.set(knm, entry);
    });

    console.log(`[_matchAndApplySummary] byNum map size: ${byNum.size}, byName map size: ${byName.size}`);

    if (keyPn && byNum.has(keyPn)) {
      const canonical = byNum.get(keyPn);
      console.log(`[_matchAndApplySummary] MATCHED by partNumber: family="${canonical.family}"`);
      out.partNumber = canonical.partNumber;
      out.partName = canonical.partName || out.partName || '';
      out.family = canonical.family || out.family || '';
      return out;
    }

    if (keyName && byName.has(keyName)) {
      const canonical = byName.get(keyName);
      console.log(`[_matchAndApplySummary] MATCHED by partName: family="${canonical.family}"`);
      out.partNumber = canonical.partNumber || out.partNumber || '';
      out.partName = canonical.partName || out.partName || '';
      out.family = canonical.family || out.family || '';
      return out;
    }

    // Fallback: try fuzzy match by searching summaryParts for substring matches
    if (pn) {
      const keySimple = pn.toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const p of this.summaryParts) {
        const cand = (p.partNumber || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (cand && (cand.includes(keySimple) || keySimple.includes(cand))) {
          console.log(`[_matchAndApplySummary] FUZZY MATCHED partNumber by substring (both-ways): family="${p.family}"`);
          out.partNumber = p.partNumber; out.partName = p.partName || out.partName || ''; out.family = p.family || out.family || '';
          return out;
        }
      }
    }
    if (pname) {
      const keySimple = pname.toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const p of this.summaryParts) {
        const cand = (p.partName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (cand && (cand.includes(keySimple) || keySimple.includes(cand))) {
          console.log(`[_matchAndApplySummary] FUZZY MATCHED partName by substring (both-ways): family="${p.family}"`);
          out.partNumber = p.partNumber || out.partNumber || ''; out.partName = p.partName || out.partName || ''; out.family = p.family || out.family || '';
          return out;
        }
      }
    }

    console.log(`[_matchAndApplySummary] NO MATCH FOUND`);
    // Ensure status normalized
    if (out.status) out.status = out.status.toUpperCase();
    return out;
  }

  _normalizeStatus(s) {
    if (!s) return null;
    const t = s.toString().trim().toUpperCase();
    if (t.includes('REPAIRED') && t.includes('CLOSED')) return 'REPAIRED/CLOSED';
    if (t === 'REPAIRED/CLOSED' || t === 'REPAIRED' || t === 'CLOSED') return 'REPAIRED/CLOSED';
    if (t.includes('SCRAP')) return 'SCRAP';
    if (t.includes('IN PROCESS') || t.includes('INPROCESS') || t.includes('IN-PROCESS') || t.includes('INPRO')) return 'IN PROCESS';
    // fallback: exact match to options
    return this.statusOptions.includes(t) ? t : null;
  }

  // Look up family from summaryParts by part number or name
  _getFamilyFromSummaryParts(partNumber, partName) {
    if (!this.summaryParts || this.summaryParts.length === 0) {
      console.log(`[_getFamilyFromSummaryParts] ERROR: summaryParts is empty!`);
      return '';
    }
    
    const pnKey = this._normalizeKey(partNumber || '');
    const pnameKey = this._normalizeKey(partName || '');

    console.log(`[_getFamilyFromSummaryParts] Looking for partNumber="${partNumber}" (norm="${pnKey}") or partName="${partName}" (norm="${pnameKey}")`);

    // 1) Exact normalized match by partNumber
    for (const p of this.summaryParts) {
      const kp = this._normalizeKey(p.partNumber || '');
      if (pnKey && kp && kp === pnKey) {
        console.log(`[_getFamilyFromSummaryParts] FOUND by partNumber: family="${p.family}"`);
        return (p.family || '').toString().trim();
      }
    }

    // 2) Exact normalized match by partName
    for (const p of this.summaryParts) {
      const kn = this._normalizeKey(p.partName || '');
      if (pnameKey && kn && kn === pnameKey) {
        console.log(`[_getFamilyFromSummaryParts] FOUND by partName: family="${p.family}"`);
        return (p.family || '').toString().trim();
      }
    }

    // 3) Both-direction simplified substring checks (handles cases like 'Revolution BT P-' -> 'revolutionbtp')
    if (partNumber) {
      const simple = (partNumber || '').toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const p of this.summaryParts) {
        const cand = (p.partNumber || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (cand && simple && (cand.includes(simple) || simple.includes(cand))) {
          console.log(`[_getFamilyFromSummaryParts] FUZZY FOUND by partNumber substring (both-ways): family="${p.family}"`);
          return (p.family || '').toString().trim();
        }
      }
    }

    if (partName) {
      const simple = (partName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const p of this.summaryParts) {
        const cand = (p.partName || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (cand && simple && (cand.includes(simple) || simple.includes(cand))) {
          console.log(`[_getFamilyFromSummaryParts] FUZZY FOUND by partName substring (both-ways): family="${p.family}"`);
          return (p.family || '').toString().trim();
        }
      }
    }

    // 4) Token-overlap scoring: compare meaningful tokens (length>=3) and pick best match
    const tokens = ((pnKey || '') + ' ' + (pnameKey || '')).split(/\s+/).filter(t => t && t.length >= 3);
    if (tokens.length > 0) {
      let best = { score: 0, part: null };
      for (const p of this.summaryParts) {
        const candidate = ((this._normalizeKey(p.partNumber || '') || '') + ' ' + (this._normalizeKey(p.partName || '') || '')).split(/\s+/).filter(t => t && t.length >= 3);
        const intersect = tokens.filter(t => candidate.includes(t)).length;
        if (intersect > best.score) best = { score: intersect, part: p };
      }
      if (best.part && best.score > 0) {
        console.log(`[_getFamilyFromSummaryParts] TOKEN MATCH (score=${best.score}) -> family="${best.part.family}"`);
        return (best.part.family || '').toString().trim();
      }
    }

    console.log(`[_getFamilyFromSummaryParts] NOT FOUND`);
    return '';
  }

  // Backfill missing family values from summaryParts on load
  _backfillFamiliesOnLoad() {
    let changed = false;
    let filled = 0;
    this.redTags.forEach(tag => {
      if (!tag.family || tag.family.toString().trim() === '') {
        const fam = this._getFamilyFromSummaryParts(tag.partNumber, tag.partName);
        if (fam && fam.trim() !== '') {
          tag.family = fam;
          changed = true;
          filled++;
        }
      }
    });
    if (changed) {
      console.log(`[backfillFamiliesOnLoad] Filled ${filled} missing family values. Saving...`);
      this.saveRedTags();
      this.render();
    } else {
      console.log(`[backfillFamiliesOnLoad] No missing family values found.`);
    }
  }

  // Full refresh: update NCs' partName, family and normalize partNumber from summaryParts
  refreshAllNcDetails() {
    const mapByNumber = new Map();
    const mapByName = new Map();
    this.summaryParts.forEach(p => {
      const keyNum = this._normalizeKey(p.partNumber);
      const keyName = this._normalizeKey(p.partName);
      const entry = { partNumber: p.partNumber, partName: p.partName, family: (p.family || '').toString().trim() };
      if (keyNum) mapByNumber.set(keyNum, entry);
      if (keyName) mapByName.set(keyName, entry);
    });

    let changed = false;
    this.redTags.forEach(tag => {
      const rawPn = (tag.partNumber || '').toString().trim();
      const pnKey = this._normalizeKey(rawPn);
      let matched = false;
      if (pnKey && mapByNumber.has(pnKey)) {
        const canonical = mapByNumber.get(pnKey);
        if (tag.partNumber !== canonical.partNumber) { tag.partNumber = canonical.partNumber; changed = true; }
        if ((tag.partName || '') !== (canonical.partName || '')) { tag.partName = canonical.partName || ''; changed = true; }
        if ((tag.family || '') !== (canonical.family || '')) { tag.family = canonical.family || ''; changed = true; }
        matched = true;
      } else if ((tag.partName || '') && mapByName.has(this._normalizeKey(tag.partName))) {
        const canonical = mapByName.get(this._normalizeKey(tag.partName));
        if (tag.partNumber !== canonical.partNumber) { tag.partNumber = canonical.partNumber; changed = true; }
        if ((tag.partName || '') !== (canonical.partName || '')) { tag.partName = canonical.partName || ''; changed = true; }
        if ((tag.family || '') !== (canonical.family || '')) { tag.family = canonical.family || ''; changed = true; }
        matched = true;
      }
      // NOTE: If no match found, PRESERVE family (don't clear it)
      // Family should only be cleared if explicitly set to empty during an edit
    });

    if (changed) {
      this.saveRedTags();
      this.render();
    }
  }

  populateForm(form, item) {
    for (const key in item) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
            if (input.type === 'checkbox') {
                input.checked = item[key];
            } else {
                input.value = item[key] || '';
            }
        }
    }
  }

  openManagePartsModal() {
    document.getElementById('add-part-form').onsubmit = (event) => this.handleAddPart(event);
    this.renderPartsTable();
    document.getElementById('manage-parts-modal').classList.add('visible');
  }

  closeManagePartsModal() {
    document.getElementById('manage-parts-modal').classList.remove('visible');
  }

  openAddPartModal() {
    document.getElementById('add-part-modal').classList.add('visible');
  }

  closeAddPartModal() {
    document.getElementById('add-part-modal').classList.remove('visible');
  }

  handleAddPart(event) {
    event.preventDefault();
    const form = event.target;
    // FIX: Added parenthesis () to .entries()
    const data = Object.fromEntries(new FormData(form).entries());

    if (!data.partNumber || !data.partName || !data.family) {
        this.app.showToast("Error: Part, Part Desc., and Family are mandatory.", 'error');
        return;
    }

    if (this.summaryParts.some(p => p.partNumber === data.partNumber)) {
        this.app.showToast(`Part ${data.partNumber} already exists.`, 'error');
        return;
    }

    this.summaryParts.push(data);
    this.saveSummaryParts();
    // Backup custom parts so user can switch back and forth
    localStorage.setItem('clarity_summary_parts_backup', JSON.stringify(this.summaryParts));
    this.populateSummaryDropdowns('new-partNumber', 'new-partName');
    this.populateSummaryDropdowns('edit-partNumber', 'edit-partName');
    this.renderPartsTable();
    // Refresh NCs so partName and family values propagate to existing NCs (full refresh)
    this.refreshAllNcDetails();
    this.app.showToast(`Part ${data.partNumber} added.`, 'success');
    form.reset();
    this.closeAddPartModal();
    this.openManagePartsModal();
  }

  openEditPartModal(partNumber) {
    const item = this.summaryParts.find(p => p.partNumber === partNumber);
    if (!item) return;

    const form = document.getElementById('edit-part-form');
    this.populateForm(form, item);
    form.onsubmit = (event) => this.handleEditPart(event, partNumber);
    document.getElementById('edit-part-modal').classList.add('visible');
  }

  closeEditPartModal() {
    document.getElementById('edit-part-modal').classList.remove('visible');
  }

  handleEditPart(event, originalPartNumber) {
    event.preventDefault();
    const form = event.target;
    // FIX: Added parenthesis () to .entries()
    const data = Object.fromEntries(new FormData(form).entries());

    if (!data.partNumber || !data.partName || !data.family) {
        this.app.showToast("Error: Part, Part Desc., and Family are mandatory.", 'error');
        return;
    }

    const index = this.summaryParts.findIndex(p => p.partNumber === originalPartNumber);
    if (index !== -1) {
        if (data.partNumber !== originalPartNumber && this.summaryParts.some(p => p.partNumber === data.partNumber)) {
            this.app.showToast(`Part ${data.partNumber} already exists.`, 'error');
            return;
        }
        this.summaryParts[index] = data;
        this.saveSummaryParts();
        this.populateSummaryDropdowns('new-partNumber', 'new-partName');
        this.populateSummaryDropdowns('edit-partNumber', 'edit-partName');
        this.renderPartsTable();
        // Full refresh to propagate updated partName/family to NCs
        this.refreshAllNcDetails();
        this.app.showToast(`Part ${data.partNumber} updated.`, 'success');
        this.closeEditPartModal();
        this.openManagePartsModal();
    }
  }

  deletePart(partNumber) {
    if (!confirm(`Delete part ${partNumber}?`)) return;
    this.summaryParts = this.summaryParts.filter(p => p.partNumber !== partNumber);
    this.saveSummaryParts();
    this.populateSummaryDropdowns('new-partNumber', 'new-partName');
    this.populateSummaryDropdowns('edit-partNumber', 'edit-partName');
    this.renderPartsTable();
    // Full refresh to clear/update NCs referencing removed part
    this.refreshAllNcDetails();
    this.app.showToast(`Part ${partNumber} deleted.`, 'success');
  }

  renderPartsTable() {
    const tableBody = document.getElementById('parts-table-body');
    const data = this.summaryParts || [];
    let html = '';
    data.forEach((item, index) => {
        const rowClass = index % 2 === 0 ? 'bg-[var(--bg-card)]' : 'bg-[var(--bg-panel)]';
        html += `
            <tr style="${rowClass}">
                <td style="padding:10px; border-right:1px solid var(--border);">${item.partNumber}</td>
                <td style="padding:10px; border-right:1px solid var(--border);">${item.partName}</td>
                <td style="padding:10px; border-right:1px solid var(--border);">${item.family}</td>
                <td style="padding:10px; text-align:center;">
                    <button class="btn" style="margin:0 5px;" onclick="app.defectTracker.openEditPartModal('${item.partNumber}')">Edit</button>
                    <button class="btn btn-danger" style="margin:0 5px;" onclick="app.defectTracker.deletePart('${item.partNumber}')">DEL</button>
                </td>
            </tr>
        `;
    });
    tableBody.innerHTML = html;
  }

  openReportsModal() {
    // Modular report generation: read UI controls and render a single report panel
    const content = document.getElementById('reports-content');
    document.getElementById('reports-modal').classList.add('visible');

    // Wire up generate/export buttons once
    const generateBtn = document.getElementById('report-generate');
    const exportBtn = document.getElementById('report-export');
    generateBtn.onclick = () => this._renderReportFromControls();
    exportBtn.onclick = () => this._exportCurrentReportCSV();

    // Ensure inspector dropdowns are up-to-date and default Group By to inspector
    this.populateInspectorDropdowns();
    const gb = document.getElementById('report-groupby');
    if (gb) gb.value = 'inspector';
    // Auto-generate with current defaults (inspector by default)
    this._renderReportFromControls();
  }

  // Build grouped data by selected key and metric
  _buildGroupedData(groupBy, metric, fromDate, toDate, allowedStatuses) {
    const data = (this.redTags || []).filter(item => {
      if (fromDate && item.dateLogged && item.dateLogged < fromDate) return false;
      if (toDate && item.dateLogged && item.dateLogged > toDate) return false;
      // If allowedStatuses provided and non-empty, filter by status
      if (allowedStatuses && Array.isArray(allowedStatuses) && allowedStatuses.length > 0) {
        // treat missing status as 'Unknown' and exclude unless explicitly present
        if (!allowedStatuses.includes(item.status)) return false;
      }
      return true;
    });

    const map = new Map();
    const itemsMap = {};
    
    data.forEach(item => {
      let key = '';
      let sortKey = '';
      
      if (groupBy === 'family') {
        key = (item.family && item.family.trim()) || (this.summaryParts.find(p => p.partNumber === item.partNumber)?.family) || 'Unknown';
      } else if (groupBy === 'partNumber') {
        key = item.partNumber || 'Unknown';
      } else if (groupBy === 'partName') {
        key = item.partName || 'Unknown';
      } else if (groupBy === 'status') {
        key = item.status || 'Unknown';
      } else if (groupBy === 'inspector') {
        key = item.inspector || 'Unknown';
      } else if (groupBy === 'dateLogged') {
        key = item.dateLogged || 'Unknown';
      } else if (groupBy === 'month') {
        // Extract YYYY-MM from date
        const date = item.dateLogged ? item.dateLogged.substring(0, 7) : 'Unknown';
        key = date;
        sortKey = date;
      } else if (groupBy === 'monthByFamily') {
        const date = item.dateLogged ? item.dateLogged.substring(0, 7) : 'Unknown';
        const family = (item.family && item.family.trim()) || 'Unknown';
        key = `${date} / ${family}`;
        sortKey = date;
      } else if (groupBy === 'monthByStatus') {
        const date = item.dateLogged ? item.dateLogged.substring(0, 7) : 'Unknown';
        const status = item.status || 'Unknown';
        key = `${date} / ${status}`;
        sortKey = date;
      } else {
        key = 'Unknown';
      }

      if (!map.has(key)) map.set(key, { value: 0, count: 0, sortKey: sortKey || key });
      if (!itemsMap[key]) itemsMap[key] = [];
      
      const existing = map.get(key);
      if (metric === 'qty') {
        existing.value += (item.qty || 0);
      } else if (metric === 'avgQty') {
        existing.value += (item.qty || 0);
        existing.count += 1;
      } else {
        existing.value += 1;
      }
      itemsMap[key].push(item);
    });

    // Convert to arrays and handle avgQty
    let arr = Array.from(map.entries()).map(([k, v]) => ({ 
      label: k, 
      value: metric === 'avgQty' ? (v.count > 0 ? Math.round((v.value / v.count) * 10) / 10 : 0) : v.value, 
      items: itemsMap[k],
      sortKey: v.sortKey
    }));
    
    // Sort: by sortKey if present (for trends), otherwise by value desc
    if (arr[0] && arr[0].sortKey && arr[0].sortKey !== arr[0].label) {
      arr.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
    } else {
      arr.sort((a, b) => b.value - a.value);
    }
    return arr;
  }

  // Render report from UI controls
  _renderReportFromControls() {
    const groupBy = document.getElementById('report-groupby').value;
    const metric = document.getElementById('report-metric').value;
    const viz = document.getElementById('report-viz').value;
    const from = document.getElementById('report-from').value || null;
    const to = document.getElementById('report-to').value || null;

    // Collect selected status filters (if none checked -> treat as all)
    const statusCheckboxes = Array.from(document.querySelectorAll('.report-status-checkbox'));
    let selectedStatuses = statusCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
    // If the 'All' checkbox is present and unchecked logic: if no checkbox checked, show all
    if (selectedStatuses.length === 0) selectedStatuses = null;

    const grouped = this._buildGroupedData(groupBy, metric, from, to, selectedStatuses);

    const content = document.getElementById('reports-content');
    content.innerHTML = '';

    if (viz === 'table') {
      content.appendChild(this._renderTableForGrouped(grouped, groupBy, metric));
      this._currentReport = { grouped, groupBy, metric, viz };
      return;
    }

    // Chart rendering (Bar or Pie)
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.gap = '12px';

    const canvas = document.createElement('canvas');
    canvas.id = 'reports-canvas';
    canvas.className = 'reports-canvas';
    canvas.style.maxHeight = '400px';
    canvas.style.width = '100%';
    wrapper.appendChild(canvas);

    // Drilldown details container (expanded by default)
    const detailsDiv = document.createElement('div');
    detailsDiv.style.flex = '1';
    detailsDiv.style.minHeight = '300px';
    detailsDiv.style.maxHeight = '600px';
    detailsDiv.style.overflow = 'auto';
    detailsDiv.style.borderTop = '1px solid var(--border)';
    detailsDiv.style.paddingTop = '12px';
    detailsDiv.style.marginTop = '12px';
    wrapper.appendChild(detailsDiv);

    content.appendChild(wrapper);

    const labels = grouped.map(g => g.label);
    const values = grouped.map(g => g.value);

    // Save current report state for export/drilldown
    this._currentReport = { grouped, groupBy, metric, viz };

    if (this._reportsChart) { try { this._reportsChart.destroy(); } catch(e){} }

    const ctx = canvas.getContext('2d');
    // Color palette: blues, cyans, teals - no reds
    const colorPalette = ['#3b82f6', '#06b6d4', '#10b981', '#8b5cf6', '#f59e0b', '#ec4899', '#14b8a6', '#0ea5e9', '#6366f1', '#d946ef'];
    const colors = labels.map((l,i) => colorPalette[i % colorPalette.length]);
    
    // Determine chart type
    let chartType = 'bar';
    if (viz === 'line') chartType = 'line';
    else if (viz === 'pie') chartType = 'doughnut';
    
    const config = {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{ 
          label: metric === 'qty' ? 'Quantity' : (metric === 'avgQty' ? 'Avg Qty' : 'Count'), 
          data: values, 
          backgroundColor: chartType === 'line' ? 'transparent' : colors,
          // For pie/doughnut remove segment borders for a cleaner look
          borderColor: chartType === 'doughnut' ? colors.map(_ => 'transparent') : (chartType === 'line' ? (colors[0] || '#3b82f6') : colors),
          borderWidth: chartType === 'doughnut' ? 0 : 1,
          tension: 0.4,
          fill: chartType === 'line' ? false : undefined,
          pointBackgroundColor: chartType === 'line' ? colors.slice(0, values.length) : undefined,
          pointBorderColor: chartType === 'line' ? '#fff' : undefined,
          pointRadius: chartType === 'line' ? 5 : undefined,
          pointHoverRadius: chartType === 'line' ? 7 : undefined
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { position: 'bottom' }, 
          tooltip: { mode: 'index' },
          title: { display: true, text: `${groupBy} Trend` }
        },
        onClick: (evt, elements) => {
          if (!elements || elements.length === 0) return;
          const idx = elements[0].index;
          const key = labels[idx];
          const items = grouped[idx].items || [];
          detailsDiv.innerHTML = this._renderDrilldownHTML(key, items);
        },
        scales: chartType === 'pie' ? {} : { 
          y: { beginAtZero: true },
          x: { ticks: { maxRotation: 45, minRotation: 0 } }
        }
      }
    };

    this._reportsChart = new Chart(ctx, config);

    // Fill details with first group by default
    if (grouped.length > 0) {
      detailsDiv.innerHTML = this._renderDrilldownHTML(labels[0], grouped[0].items || []);
    }
  }

  _renderDrilldownHTML(groupLabel, items) {
    if (!items || items.length === 0) {
      return `<div style="padding:12px; color:var(--text-muted);">No items in <strong>${this.app.escapeHtml(groupLabel)}</strong></div>`;
    }
    
    let html = `<div style="margin-bottom:16px;">
      <h3 style="color:var(--accent); margin:0 0 12px 0; font-size:0.95rem;">üìã ${this.app.escapeHtml(groupLabel)} (${items.length})</h3>
      <div style="display:flex; flex-direction:column; gap:6px;">`;
    
    items.forEach((item, idx) => {
      const statusColor = item.status === 'REPAIRED/CLOSED' ? '#10b981' : (item.status === 'SCRAP' ? '#f97316' : '#3b82f6');
      const desc = item.description ? this.app.escapeHtml((item.description || '').substring(0, 240)) : '';
      html += `<div style="padding:8px 10px; border-left:3px solid ${statusColor}; background:var(--bg-panel); border-radius:2px; font-size:0.9rem; color:var(--text-main);">
        <div style="font-weight:700;">${this.app.escapeHtml(item.nc)}</div>
        ${desc ? `<div style="margin-top:6px; font-size:0.8rem; color:var(--text-muted); white-space:pre-wrap; overflow:hidden; max-height:96px;">${desc}${(item.description && item.description.length>240)?'‚Ä¶':''}</div>` : ''}
      </div>`;
    });
    
    html += `</div></div>`;
    return html;
  }

  // Toggle reports modal fullscreen and resize chart
  toggleReportFullscreen() {
    const modal = document.getElementById('reports-modal');
    if (!modal) return;
    const content = modal.querySelector('.modal-content');
    if (!content) return;
    const expanded = content.classList.toggle('reports-fullscreen');
    // Adjust canvas size class
    const canvas = document.getElementById('reports-canvas');
    if (canvas) {
      if (expanded) {
        canvas.classList.add('reports-canvas-full');
      } else {
        canvas.classList.remove('reports-canvas-full');
        canvas.style.height = '';
      }
      // trigger chart resize
      try { if (this._reportsChart) this._reportsChart.resize(); } catch(e){}
    }
  }

  _renderGroupedSummaryHTML(grouped) {
    let html = '<table style="width:100%; border-collapse:collapse;">';
    html += '<thead style="background:var(--bg-panel); color:var(--accent); font-weight:700;\"><tr><th style="padding:8px; text-align:left;">Group</th><th style="padding:8px; text-align:right;">Value</th><th style="padding:8px; text-align:left;">Sample Items</th></tr></thead><tbody>';
    grouped.slice(0,200).forEach(g => {
      html += `<tr style="border-bottom:1px solid var(--border);"><td style="padding:8px;">${this.app.escapeHtml(g.label)}</td><td style="padding:8px; text-align:right;">${g.value}</td><td style="padding:8px;">${this._renderSampleItemsText(g.items)}</td></tr>`;
    });
    html += '</tbody></table>';
    return html;
  }

  _renderSampleItemsText(items) {
    return items.slice(0,3).map(i => `${i.nc}${i.partNumber?` (${i.partNumber})`:''}`).join('; ');
  }

  _renderItemsTableHTML(items) {
    if (!items || items.length === 0) return '<div style="padding:8px; color:var(--text-muted);">No items</div>';
    let html = '<table style="width:100%; border-collapse:collapse;\"><thead style="background:var(--bg-panel); color:var(--accent); font-weight:700;\"><tr><th style="padding:6px; text-align:left;">NC#</th><th style="padding:6px; text-align:left;">Part</th><th style="padding:6px; text-align:left;">Status</th><th style="padding:6px; text-align:left;">Date</th><th style="padding:6px; text-align:left;">Description</th></tr></thead><tbody>';
    items.forEach(it => {
      const descPreview = (it.description || '').substring(0, 60) + (it.description && it.description.length > 60 ? '...' : '');
      html += `<tr style="border-bottom:1px solid var(--border);"><td style="padding:6px;">${this.app.escapeHtml(it.nc)}</td><td style="padding:6px;">${this.app.escapeHtml(it.partNumber||'')}</td><td style="padding:6px;">${this.app.escapeHtml(it.status||'')}</td><td style="padding:6px; font-size:0.8rem;">${this.app.escapeHtml(it.dateLogged||'')}</td><td style="padding:6px; font-size:0.8rem; color:var(--text-muted);">${this.app.escapeHtml(descPreview)}</td></tr>`;
    });
    html += '</tbody></table>';
    return html;
  }

  _renderTableForGrouped(grouped, groupBy, metric) {
    const container = document.createElement('div');
    container.style.maxHeight = '560px';
    container.style.overflow = 'auto';
    let html = '<table style="width:100%; border-collapse:collapse;\"><thead style="background:var(--bg-panel); color:var(--accent); font-weight:700;\"><tr><th style="padding:8px; text-align:left;">Group</th><th style="padding:8px; text-align:right;">Value</th><th style="padding:8px; text-align:left;">Sample NCs</th></tr></thead><tbody>';
    grouped.forEach(g => {
      html += `<tr style="border-bottom:1px solid var(--border);"><td style="padding:8px;">${this.app.escapeHtml(g.label)}</td><td style="padding:8px; text-align:right;">${g.value}</td><td style="padding:8px;">${this._renderSampleItemsText(g.items)}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
    return container;
  }

  _exportCurrentReportCSV() {
    if (!this._currentReport || !this._currentReport.grouped) return this.app.showToast('No report to export','error');
    const grouped = this._currentReport.grouped;
    // Build CSV
    const rows = [['Group','Value','SampleNCs']];
    grouped.forEach(g => rows.push([`"${g.label.replace(/"/g,'""')}"`, g.value, `"${(g.items||[]).slice(0,5).map(i=>i.nc).join('; ').replace(/"/g,'""')}"`]));
    const csv = rows.map(r=>r.join(',')).join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `clarity_report_${new Date().toISOString().split('T')[0]}.csv`; a.click();
    this.app.showToast('Report exported');
  }

  toggleGraph(graph) {
    this.graphVisibility[graph] = !this.graphVisibility[graph];
    this.openReportsModal();
  }

  closeReportsModal() {
    document.getElementById('reports-modal').classList.remove('visible');
    try {
      if (this._reportsChart) { this._reportsChart.destroy(); this._reportsChart = null; }
    } catch(e) { console.error('Error destroying reports chart', e); }
  }

  closeAddModal() {
    document.getElementById('add-nc-modal').classList.remove('visible');
  }

  closeEditModal() {
    document.getElementById('edit-nc-modal').classList.remove('visible');
  }

  toggleMode() {
    const newMode = this.app.state.mode === 'kanban' ? 'defects' : 'kanban';
    this.app.toggleMode(newMode);
    this.app.saveState();
  }

  initialRedTags = [
    { nc: 'NC-00001', status: 'REPAIRED/CLOSED', partNumber: 'Revolution BT P-', serial: '63684', partName: 'P-REVOLUTN004', dateLogged: '2025-03-28', qty: 1, inspector: 'TLG', description: 'Unit aborts in tester after Comm board replacement. Replace Digital', disposition: "Rework unit. Replace digital and repair below NC's EJL 04/11/2025", notes: 'Replaced digital and power (power = NC-0001.1). Replaced banana jack wires (NC-0001.3) (JAB 4/14/25)' },
    { nc: 'NC-00001.1', status: 'SCRAP', partNumber: 'Revolution Power Sub assembly', serial: 'i6620', partName: 'REVPOSA', dateLogged: '2025-04-11', qty: 1, inspector: 'JAB', description: 'Power supply has two wires(red and black) that are crimped/damaged. Unable to repair, unit is potted.', disposition: 'Remove RevFUSE and scrap. EJL 04/11/2025', notes: '' },
    { nc: 'NC-00001.2', status: 'REPAIRED/CLOSED', partNumber: 'Revolution BT COMM Board TH', serial: 'i7574', partName: 'REVCBTH_REV_B', dateLogged: '2025-04-11', qty: 1, inspector: 'JAB/EJL', description: 'Excessive solder on comm board from power wires', disposition: 'Remo power wires, Wick solder and...', notes: '' },
    { nc: 'NC-00002', status: 'IN PROCESS', partNumber: 'Seeker Digital', serial: 'j1001', partName: 'SEEDQSM', dateLogged: '2025-05-01', qty: 5, inspector: 'EAC', description: 'No Ethernet communication - Phase 2 failure.', disposition: 'Check T1 solder joints, rework if necessary.', notes: 'Waiting for rework station availability.' },
    { nc: 'NC-00003', status: 'SCRAP', partNumber: 'Bolt Power', serial: 'k5050', partName: 'BOLTPSM', dateLogged: '2025-05-15', qty: 1, inspector: 'TLG', description: 'Reading 9.5 volts instead of 5V, C3/C13 Tombstoned', disposition: 'Resolder components (C3/C13 Tombstoned), but unit was scrapped.', notes: 'Component failure confirmed. Replaced board.' },
    { nc: 'NC-00004', status: 'IN PROCESS', partNumber: 'Guardian Digital', serial: 'i2002', partName: 'GUDISM', dateLogged: '2025-05-20', qty: 2, inspector: 'ETB', description: 'DSP Not Responding (Failed ALIVE check), suspected U10 failure.', disposition: 'Awaiting replacement U10 component.', notes: 'Board sent to engineering for further diagnostics.' },
  ];

  initialSummaryParts = [
    { partNumber: 'ATOPCSM_REV_D(5/1/23)', partName: 'Atom board SMT', family: 'ATOM' },
    { partNumber: 'ATOPCTH_REV_D(5/1/23)', partName: 'Atom board TH', family: 'ATOM' },
    { partNumber: 'ATOM_REV_D(12/11/23)', partName: 'Atom unit Finished Goods', family: 'ATOM' },
    { partNumber: 'FCT00309500-B', partName: 'Bolt 9" Flex assembly', family: 'FCT' },
    { partNumber: 'CABVBOLT', partName: 'Bolt Cable AC', family: 'Cables' },
    { partNumber: 'CABVBOLT-48', partName: 'Bolt Cable AC48', family: 'Cables' },
    { partNumber: 'CABVBOLTDC', partName: 'Bolt Cable DC', family: 'Cables' },
    { partNumber: 'CABVBOLTDC-48', partName: 'Bolt cable DC48', family: 'Cables' },
    { partNumber: 'BOLT CELL DIGITAL TH', partName: 'Bolt CELL Digi SMT', family: 'Bolt' },
    { partNumber: 'BOLT CELL DIGITAL SMT', partName: 'Bolt CELL Digi TH', family: 'Bolt' },
    { partNumber: 'BOLT CURRENT TH', partName: 'Bolt Curent TH', family: 'Bolt' },
    { partNumber: 'BOLT CURRENT SMT', partName: 'Bolt Current SM', family: 'Bolt' },
    { partNumber: 'BOLTUSBCSA', partName: 'Bolt Dongle', family: 'Bolt' },
    { partNumber: 'BOLTENCL', partName: 'Bolt housing', family: 'Bolt' },
    { partNumber: 'BOLTISM_REV_G(3/8/24)', partName: 'Bolt isolator SM', family: 'Bolt' },
    { partNumber: 'BOLT POWER SMT REV_F(9/2/25)', partName: 'Bolt Power SM', family: 'Bolt' },
    { partNumber: 'BOLT POWER TH', partName: 'Bolt Power TH', family: 'Bolt' },
    { partNumber: 'P-BOLT', partName: 'P-Bolt unit', family: 'Bolt' },
    { partNumber: 'BOLT (Top Level)', partName: 'Bolt unit AC Finished Goods', family: 'Bolt' },
    { partNumber: 'BOLT (Top Level) - DC', partName: 'Bolt unit DC Finished Goods', family: 'Bolt' },
    { partNumber: 'BOLTUSBSM_REV_C(5/17/24)', partName: 'Bolt USB Board', family: 'Bolt' },
    { partNumber: 'BOLTVSM Voltage-REV_G(11/1/24)', partName: 'Bolt Voltage SM', family: 'Bolt' },
    { partNumber: 'BOLTVTH Voltage-REV_REV_G(11/1/24)', partName: 'Bolt Voltage TH', family: 'Bolt' },
    { partNumber: 'BOLT WIFI DIGITAL SMT', partName: 'Bolt WIFI Digi SMT', family: 'Bolt' },
    { partNumber: 'BOLT WIFI DIGITAL TH', partName: 'Bolt WIFI Digi TH', family: 'Bolt' },
    { partNumber: 'BOORESM_REV_C(6/15/23)', partName: 'Boomerang 3-Phase SM', family: 'Boomerang' },
    { partNumber: 'BOORETH_Rev_C(6/15/23)', partName: 'Boomerang 3-Phase TH', family: 'Boomerang' },
    { partNumber: 'BOOSOSM_G02(2/17/23)', partName: 'Boomerang socket SM', family: 'Boomerang' },
    { partNumber: 'BOOSOCU', partName: 'Boomerang socket TH', family: 'Boomerang' },
    { partNumber: 'BOLT CELL (TOP LEVEL)', partName: 'Cell Bolt AC', family: 'Bolt' },
    { partNumber: 'BOLT CELL (TOP LEVEL) - DC', partName: 'Cell Bolt DC', family: 'Bolt' },
    { partNumber: 'FCTPCSM', partName: 'Flex board SM', family: 'FCT' },
    { partNumber: 'FCTPCTH', partName: 'FLEX board TH', family: 'FCT' },
    { partNumber: 'FCTPCSA', partName: 'Flex Enclosure Assembly', family: 'FCT' },
    { partNumber: 'GUARDATSC', partName: 'Guardian Cell FG', family: 'Guardian' },
    { partNumber: 'P-GUARDATSC', partName: 'Guardian Cell P-', family: 'Guardian' },
    { partNumber: 'GUATQCSM_Rev_A (2/23/23)', partName: 'Guardian Cell SM', family: 'Guardian' },
    { partNumber: 'GUATQCTH_REV_A(2/23/23)', partName: 'Guardian Cell TH', family: 'Guardian' },
    { partNumber: 'GUAENBU', partName: 'Guardian Enclosure Blue w Guacomm', family: 'Guardian' },
    { partNumber: 'GUAENGR', partName: 'Guardian Enclosure Grey with stickers', family: 'Guardian' },
    { partNumber: 'P-30270091', partName: 'Guardian Enclosure Milled', family: 'Housings' },
    { partNumber: 'CABGNDC', partName: 'Guardian Ground cable', family: 'Cables' },
    { partNumber: 'GUACOMM', partName: 'Guardian Guacomm', family: 'Guardian' },
    { partNumber: 'GUAPNSMRevC_01', partName: 'Guardian Power board SM', family: 'Guardian' },
    { partNumber: 'GUAPNTH', partName: 'Guardian Power board TH', family: 'Guardian' },
    { partNumber: 'GUAPNSA', partName: 'Guardian PWR Sub assembly', family: 'Guardian' },
    { partNumber: 'GUACAPS', partName: 'Guardian super Caps', family: 'Guardian' },
    { partNumber: 'GUARDATS0', partName: 'Guardian USB FG', family: 'Guardian' },
    { partNumber: 'P-GUARDATS0', partName: 'Guardian USB P-', family: 'Guardian' },
    { partNumber: 'GUATQUSM_REV_A(2/23/23)', partName: 'Guardian USB SM', family: 'Guardian' },
    { partNumber: 'GUATQUTH_REV_A(2/23/23)', partName: 'Guardian USB TH', family: 'Guardian' },
    { partNumber: 'GUARDATSW', partName: 'Guardian WIFI FG', family: 'Guardian' },
    { partNumber: 'P-GUARDATSW', partName: 'Guardian WIFI p-', family: 'Guardian' },
    { partNumber: 'GUATQWSM_REV_A(2/23/23)', partName: 'Guardian WIFI SM', family: 'Guardian' },
    { partNumber: 'GUATQWTH_REV_A(2/23/23)', partName: 'Guardian WIFI TH', family: 'Guardian' },
    { partNumber: 'REVCBSM', partName: 'Revolution BT COMM Board SM', family: 'Revolution' },
    { partNumber: 'REVCBTH_REV_B', partName: 'Revolution BT COMM Board TH', family: 'Revolution' },
    { partNumber: 'REVOLUTN004', partName: 'Revolution BT FG', family: 'Revolution' },
    { partNumber: 'P-REVOLUTN004', partName: 'Revolution BT P-', family: 'Revolution' },
    { partNumber: 'REVCCSM', partName: 'Revolution CELL COMM Board SM', family: 'Revolution' },
    { partNumber: 'REVCCTH', partName: 'Revolution CELL COMM Board TH', family: 'Revolution' },
    { partNumber: 'REVOLUTN008', partName: 'Revolution CELL FG', family: 'Revolution' },
    { partNumber: 'REVMOSA', partName: 'Revolution CELL MODEM', family: 'Revolution' },
    { partNumber: 'P-REVOLUTN008', partName: 'Revolution CELL P-', family: 'Revolution' },
    { partNumber: 'REVDISM', partName: 'Revolution Digital SM', family: 'Revolution' },
    { partNumber: 'REVDITH', partName: 'Revolution Digital TH', family: 'Revolution' },
    { partNumber: 'REVENBT', partName: 'Revolution Enclosure BT', family: 'Housings' },
    { partNumber: 'REVENCE', partName: 'Revolution Enclosure CELL', family: 'Housings' },
    { partNumber: 'P-30270061-1', partName: 'Revolution Enclosure Cell Milled', family: 'Housings' },
    { partNumber: 'REVFUSE', partName: 'Revolution Fuse board', family: 'Revolution' },
    { partNumber: 'P1-30270061-2', partName: 'Revolution Power Milled housing', family: 'Revolution' },
    { partNumber: 'REVPOSM_Rev_C1(2/17/23)', partName: 'Revolution Power SM', family: 'Revolution' },
    { partNumber: 'REVPOSA', partName: 'Revolution Power Sub assembly', family: 'Revolution' },
    { partNumber: 'REVPOTH_RevC1(2/17/23)', partName: 'Revolution Power TH', family: 'Revolution' },
    { partNumber: 'REVVCSM', partName: 'Revolution VCHAN SM', family: 'Revolution' },
    { partNumber: 'REVVCTH', partName: 'Revolution VCHAN TH', family: 'Revolution' },
    { partNumber: 'SEEDQSM-EGW_REV_A02(2/27/23)', partName: 'Seeker CELL DIGITAL SM', family: 'Seeker' },
    { partNumber: 'SEEDQATH-EGW_REV_A02(2/27/23)', partName: 'Seeker CELL DIGITAL TH', family: 'Seeker' },
    { partNumber: 'SEEENGC', partName: 'Seeker Cell Enclosure', family: 'Seeker' },
    { partNumber: 'SEEKERC', partName: 'Seeker CELL FG', family: 'Seeker' },
    { partNumber: 'P2-30270112', partName: 'Seeker Cell housing Milled', family: 'Seeker' },
    { partNumber: 'P-SEEKERCE', partName: 'Seeker CELL P-', family: 'Seeker' },
    { partNumber: 'SEEIOSM_REV_A(3/10/23 USB)', partName: 'Seeker IO SM', family: 'Seeker' },
    { partNumber: 'SEEIOTH_REV_A(3/10/23 USB)', partName: 'Seeker IO TH', family: 'Seeker' },
    { partNumber: 'SEEPESA', partName: 'Seeker Power entry Sub assembly', family: 'Seeker' },
    { partNumber: 'SEEPGSM_REV_E(7/6/23)', partName: 'Seeker Power SM', family: 'Seeker' },
    { partNumber: 'SEEPGSA', partName: 'Seeker Power Sub assembly', family: 'Seeker' },
    { partNumber: 'SEEPGTH_REV_E(7/6/23)', partName: 'Seeker Power TH', family: 'Seeker' },
    { partNumber: 'SEEDQSM-CEGW_REV_A02(2/27/23)', partName: 'Seeker WIFI DIGITAL SM', family: 'Seeker' },
    { partNumber: 'SEEDQATH-CEGW_REV_A02(2/27/23)', partName: 'Seeker WIFI DIGITAL TH', family: 'Seeker' },
    { partNumber: 'SEEENG', partName: 'Seeker Wifi Enclosure', family: 'Housings' },
    { partNumber: 'SEEKER', partName: 'Seeker WIFI FG', family: 'Seeker' },
    { partNumber: 'P1-30270112', partName: 'Seeker Wifi housing milled', family: 'Housings' },
    { partNumber: 'P-SEEKER', partName: 'Seeker WIFI P-', family: 'Seeker' },
    { partNumber: 'TENSENC', partName: 'Tensor Cell enlosure', family: 'Housings' },
    { partNumber: 'TENSORCP(DNU - USE THE ITEM GROUP)', partName: 'Tensor CELL FG', family: 'Tensor' },
    { partNumber: 'P-30270108', partName: 'Tensor Cell housing Milled', family: 'Housings' },
    { partNumber: 'TENPQCSM_Rev_B(7/18/23)', partName: 'Tensor Cell SM', family: 'Tensor' },
    { partNumber: 'TENPQCTH_REV_B(7/18/23)', partName: 'Tensor Cell TH', family: 'Tensor' },
    { partNumber: 'P-TENSORC', partName: 'Tensor CELLP-', family: 'Tensor' },
    { partNumber: 'TENDASM', partName: 'Tensor Daughter Board', family: 'Tensor' },
    { partNumber: 'TENSENW', partName: 'Tensor Wifi Enclosure', family: 'Housings' },
    { partNumber: 'TENSORWP(DNU - USE ITEM GROUP)', partName: 'Tensor WIFI FG', family: 'Tensor' },
    { partNumber: 'P-30400080', partName: 'Tensor WIFI housing milled', family: 'h' },
    { partNumber: 'P-TENSORW', partName: 'Tensor WIFI P-', family: 'Tensor' },
    { partNumber: 'TENPQWSM_REV_B(7/18/23)', partName: 'Tensor Wifi SM', family: 'Tensor' },
    { partNumber: 'TENPQWTH_REV_B(7/18/23)', partName: 'Tensor Wifi TH', family: 'Tensor' },
    { partNumber: 'TLAPCSM', partName: 'TLAR Board SM', family: 'TLAR' },
    { partNumber: 'TLAPCTH', partName: 'TLAR Board TH', family: 'TLAR' },
    { partNumber: 'TLAPCSA', partName: 'TLAR Enclosure Assembly', family: 'TLAR' }
  ];

  statusOptions = ['REPAIRED/CLOSED', 'SCRAP', 'IN PROCESS'];

  columnMap = {
    'nc#': 'nc', 'status': 'status', 'part number': 'partNumber', 'partname': 'partName', 
    'serial': 'serial', 'date': 'dateLogged', 'qty': 'qty', 'inspector': 'inspector', 
    'description': 'description', 'disposition': 'disposition', 'notes': 'notes'
  };
}
</script>
<script>
var app;
document.addEventListener('DOMContentLoaded', () => {
  app = new ClarityApp();
  window.app = app;

  // Enable login button safely
  try {
    const lb = document.getElementById('login-btn');
    if (lb) lb.disabled = false;
  } catch(e){}

  // Verify Firebase libs loaded correctly (optional but fine)
  setTimeout(() => {
    const errEl = document.getElementById('login-error');
    if (!window.firebase || !firebase.initializeApp || !firebase.auth) {
      const msg = 'Firebase libraries failed to load. Check network/CDN or use local SDK. See console.';
      console.error(msg);
      if (errEl) errEl.textContent = msg;
      try { const lb = document.getElementById('login-btn'); if (lb) lb.disabled = true; } catch(e){}
    } else {
      if (errEl && errEl.textContent === 'Loading...') errEl.textContent = '';
    }
  }, 250);
});
</script>


<script>
// Ensure we have a ClarityApp instance (in case something loaded out of order)
if (!(window.app instanceof ClarityApp)) {
  window.app = new ClarityApp();
}

// If this build doesn't have updateTask, define it now (permanent fix you wanted)
if (typeof ClarityApp?.prototype?.updateTask !== 'function') {
  ClarityApp.prototype.updateTask = function (id, changes) {
    this.historyManager.push();
    const task = this.state.tasks.find(t => t.id === id);
    if (!task) { console.warn('Task not found for update:', id); return; }
    Object.assign(task, changes);
    this.saveState();     // debounced in your newer version, otherwise fine
    this.renderBoard();
    this.showToast('Task updated');
  };
  console.log('‚úî updateTask was missing ‚Äî FIXED');
}

// Optional: guard against later overwrites of window.app
try { Object.defineProperty(window, 'app', { writable: false, configurable: false }); } catch {}

// Diagnostic: check in Console after reload
console.log('[clarity check]', window.app?.constructor?.name, 'updateTask =', typeof window.app?.updateTask);

// Wire floating buttons: visibility + click handlers
(function(){
  const container = document.getElementById('floating-rt-actions');
  const btnNew = document.getElementById('floating-new-nc');
  const btnReports = document.getElementById('floating-view-reports');

  function updateVisibility(){
    // Show only when defect tracker mode is active
    try {
      if (window.app && window.app.state && window.app.state.mode === 'defects') {
        container.classList.remove('hidden');
        container.setAttribute('aria-hidden','false');
      } else {
        container.classList.add('hidden');
        container.setAttribute('aria-hidden','true');
      }
    } catch(e) { /* safe-fail */ }
  }

  // Click handlers
  if (btnNew) btnNew.onclick = () => { try { window.app.defectTracker.prepareAddNC(); } catch(e){console.error(e);} };
  if (btnReports) btnReports.onclick = () => { try { window.app.defectTracker.openReportsModal(); } catch(e){console.error(e);} };

  // Polling fallback: update visibility periodically and on toggle
  updateVisibility();
  const iv = setInterval(updateVisibility, 700);
  // Also update when app.toggleMode exists (wrap it if present)
  if (window.app && typeof window.app.toggleMode === 'function') {
    const orig = window.app.toggleMode.bind(window.app);
    window.app.toggleMode = function(mode){
      const res = orig(mode);
      setTimeout(updateVisibility, 60);
      return res;
    };
  }
  // Cleanup when page unloads
  window.addEventListener('beforeunload', ()=> clearInterval(iv));
})();
</script>
   
<script>
/* Global helper that always works, even if app.updateTask is missing */
window.handleUpdateTask = function(id, changes) {
  try {
    if (!window.app || !window.app.state || !Array.isArray(window.app.state.tasks)) {
      console.warn('App not ready yet'); 
      return;
    }
    // record history if available
    if (window.app.historyManager?.push) window.app.historyManager.push();

    // apply the change to the task
    const t = window.app.state.tasks.find(x => x.id === id);
    if (!t) { console.warn('Task not found:', id); return; }
    Object.assign(t, changes);

    // save + re-render (if those functions exist)
    window.app.saveState?.();
    window.app.renderBoard?.();
    window.app.showToast?.('Task updated');
  } catch (e) {
    console.error('handleUpdateTask failed:', e);
  }
};
</script>
<script> 
// Initialize the sync for the first time
app.initRealtimeSync();

// The "Background Sinker" - stops data usage when tab is hidden
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        // Stop the listener to save data
        if (app && app.syncUnsubscribe) {
            app.syncUnsubscribe();
            app.syncUnsubscribe = null;
            console.log("Sync paused (Tab Hidden)");
        }
    } else {
        // Restart the listener when the user returns
        if (app) {
            app.initRealtimeSync();
            console.log("Sync resumed (Tab Active)");
        }
    }
});
</script>
</body>
</html>




















